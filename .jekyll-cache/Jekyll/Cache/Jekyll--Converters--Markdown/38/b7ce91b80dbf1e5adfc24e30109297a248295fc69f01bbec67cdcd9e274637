I"Ô <h4 id="å‰è¨€">å‰è¨€</h4>
<p>ActivityThread æ˜¯æ¶ˆæ¯é©±åŠ¨çš„æ´»ç”Ÿç”Ÿçš„ç»å…¸æ¡ˆä¾‹ï¼<br />
ActivityThread çš„ main å‡½æ•° Looper.loop() é˜»å¡ï¼Œ<br />
Application ç»™ ActivityThread å‘æ¶ˆæ¯ã€‚<br /></p>

<h4 id="å›é¡¾">å›é¡¾</h4>
<p>é“¾æ¥ï¼š<a href="https://blog.csdn.net/gh1026385964/article/details/80584903"> Android Launcher å¯åŠ¨ APP æµç¨‹çš„æºç åˆ†æ </a>ï¼Œ
ä»¥å‰å†™çš„ï¼ŒåŸºäº Android7.0 æºç ï¼Œåˆ†æäº† AMS å¯åŠ¨ APP çš„æµç¨‹ã€‚<br /></p>

<p>æœ€è¿‘çœ‹äº† Android9.0 çš„ç›¸å…³æºç ï¼Œå‘ç°æ”¹åŠ¨ç•¥å¤šï¼Œç‰¹æ­¤åšä¸€ä¸‹è®°å½•åˆ†æã€‚<br /></p>

<p>åœ¨è¯¥åŸºäº Android7.0 æ–‡ç« ï¼š<a href="https://blog.csdn.net/gh1026385964/article/details/80584903"> Android Launcher å¯åŠ¨ APP æµç¨‹çš„æºç åˆ†æ </a> ä¸­ï¼Œ
ç¬¬å››-ç¬¬äº”æ­¥ï¼ŒActivityThread#main å‡½æ•°çš„è§¦å‘ï¼š
AMS#startProcessLockedï¼Œfork äº†å­è¿›ç¨‹ä½œä¸ºæ–°APPçš„çº¿ç¨‹ï¼Œ
æ¥ç€æ–°APPçš„çº¿ç¨‹é€šè¿‡åå°„ï¼Œè§¦å‘äº†æ–°APPçš„ä¸»çº¿ç¨‹ ActivityThread#main å‡½æ•°ï¼›<br /></p>

<p>ç¬¬å…­-ç¬¬ä¸ƒæ­¥ï¼ŒActivityçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•° onCreate è§¦å‘ï¼š
AMS#attachApplication å‘èµ·äº†è·¨è¿›ç¨‹é€šä¿¡ï¼Œ
è°ƒç”¨ ApplicationThread#scheduleLaunchActivity ï¼Œè¿›è€Œè§¦å‘ Activityçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•° onCreate ã€‚<br /></p>

<h4 id="activitythreadmain-å‡½æ•°çš„è§¦å‘è°ƒç”¨é“¾ä¸º">ActivityThread#main å‡½æ•°çš„è§¦å‘ï¼Œè°ƒç”¨é“¾ä¸ºï¼š</h4>

<ul>
  <li>AMS#startProcessLocked</li>
  <li>Process.start
    <ul>
      <li>Process.javaçš„startå‡½æ•°ï¼Œå°†é€šè¿‡ socket å‘é€æ¶ˆæ¯ç»™ zygote</li>
      <li>zygote å°†æ´¾ç”Ÿå‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œ</li>
      <li>å­è¿›ç¨‹å°†é€šè¿‡åå°„è°ƒç”¨æ–°è¿›ç¨‹ï¼ˆæ–°APPï¼‰ ActivityThread çš„ main å‡½æ•°</li>
    </ul>
  </li>
  <li>ActivityThread#main
-Looper.prepareMainLooper();
    <ul>
      <li>ActivityThread thread = new ActivityThread();</li>
      <li>thread.attach(false);
        <ul>
          <li>mInstrumentation = new Instrumentation();// åç»­è°ƒç”¨ Activity ç”Ÿå‘½å‘¨æœŸå‡½æ•°</li>
          <li>ContextImpl context = ContextImpl.createAppContext(this, getSystemContext().mPackageInfo);</li>
          <li>mInitialApplication = context.mPackageInfo.makeApplication(true, null);</li>
          <li>mInitialApplication.onCreate(); â€“&gt; Application#onCreate</li>
        </ul>
      </li>
      <li>sMainThreadHandler = thread.getHandler(); // ä¸»çº¿ç¨‹</li>
      <li>Looper.loop();</li>
    </ul>
  </li>
</ul>

<p><br /></p>
<h4 id="activityçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°-oncreate-è§¦å‘è°ƒç”¨é“¾ä¸º">Activityçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•° onCreate è§¦å‘ï¼Œè°ƒç”¨é“¾ä¸ºï¼š</h4>

<ul>
  <li>AMS#attachApplication</li>
  <li>ActivityStackSupervisor#attachApplicationLocked
    <ul>
      <li>thread.bindApplication</li>
    </ul>
  </li>
  <li>ActivityStackSupervisor#realStartActivityLocked
    <ul>
      <li>app.thread.scheduleLaunchActivity // è·¨è¿›ç¨‹é€šä¿¡</li>
    </ul>
  </li>
  <li>ApplicationThread#scheduleLaunchActivity
    <ul>
      <li>sendMessage(H.LAUNCH_ACTIVITY, r);</li>
    </ul>
  </li>
  <li>H#handleMessage
    <ul>
      <li>case LAUNCH_ACTIVITY: handleLaunchActivity</li>
    </ul>
  </li>
  <li>ActivityThread#performLaunchActivity
    <ul>
      <li>mInstrumentation.callActivityOnCreate
        <ul>
          <li>activity.performCreate</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Activity#performCreate
    <ul>
      <li>onCreate // è§¦å‘äº†ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€ä¸ªå‡½æ•° onCreate
<br /></li>
    </ul>
  </li>
</ul>

<h4 id="90-çš„å˜åŒ–">9.0 çš„å˜åŒ–</h4>

<p><a href="https://www.androidos.net.cn/android/9.0.0_r8/xref//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java#"> Android9.0 æºç æ¥æº </a> <br /></p>

<p>åœ¨ 9.0 ä¸­ï¼ŒApplicationThread æ²¡æœ‰äº† scheduleLaunchActivity å‡½æ•°ã€‚<br /></p>

<p>ä½†ä»è¿™ä¸€æ®µå¾€ä¸‹æ²¡æœ‰å˜ï¼Œ</p>
<ul>
  <li>ActivityThread#performLaunchActivity
    <ul>
      <li>mInstrumentation.callActivityOnCreate</li>
    </ul>
  </li>
</ul>

<p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„æ˜¯ä» AMS â€“&gt; ActivityThread#performLaunchActivity â€“&gt; Activity#onCreate è¿™ä¸€æ®µçš„æµç¨‹ã€‚<br /></p>

<p>å‚è€ƒé“¾æ¥ï¼šhttps://blog.csdn.net/isJoker/article/details/95523840<br /></p>

<h4 id="90-çš„è°ƒç”¨é“¾">9.0 çš„è°ƒç”¨é“¾</h4>

<ul>
  <li>
    <p>AMS#startActivityAsUser</p>
  </li>
  <li>
    <p>å±‚å±‚è°ƒç”¨</p>
  </li>
  <li>
    <p>ActivityStackSupervisor#realStartActivityLocked ï¼ˆå¯¹æ¯”7.0æºç ï¼Œæ­¤å¤„å¼€å§‹æœ‰å˜åŒ–ï¼‰</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>    final boolean realStartActivityLocked(ActivityRecord r, ProcessRecord app,
            boolean andResume, boolean checkConfig) throws RemoteException {
	// ã€‚ã€‚ã€‚
	// Create activity launch transaction.
                final ClientTransaction clientTransaction = ClientTransaction.obtain(app.thread,
                        r.appToken);
                clientTransaction.addCallback(LaunchActivityItem.obtain(new Intent(r.intent),
	// ã€‚ã€‚ã€‚
                // Set desired final state.
                final ActivityLifecycleItem lifecycleItem;
                if (andResume) {
                    lifecycleItem = ResumeActivityItem.obtain(mService.isNextTransitionForward());
                } else {
                    lifecycleItem = PauseActivityItem.obtain();
                }
                clientTransaction.setLifecycleStateRequest(lifecycleItem);

                // Schedule transaction.
                mService.getLifecycleManager().scheduleTransaction(clientTransaction);
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p>è·¨è¿›ç¨‹é€šä¿¡</p>
  </li>
  <li>ApplicationThread#scheduleTransaction
    <ul>
      <li>ActivityThread.this.scheduleTransaction(transaction);</li>
    </ul>
  </li>
  <li>ActivityThread^ClientTransactionHandler#scheduleTransaction
    <ul>
      <li>sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</li>
    </ul>
  </li>
  <li>H#handleMessage â€“ case EXECUTE_TRANSACTION
    <ul>
      <li>final ClientTransaction transaction = (ClientTransaction) msg.obj;</li>
      <li>mTransactionExecutor.execute(transaction);</li>
    </ul>
  </li>
  <li>
    <p>TransactionExecutor#execute</p>
  </li>
  <li>TransactionExecutor#executeLifecycleState
    <ul>
      <li>final ActivityLifecycleItem lifecycleItem = transaction.getLifecycleStateRequest();</li>
      <li>cycleToPath(r, lifecycleItem.getTargetState(), true /* excludeLastState */);</li>
    </ul>
  </li>
  <li>
    <p>TransactionExecutor#cycleToPath</p>
  </li>
  <li>TransactionExecutor#performLifecycleSequence - case ON_CREATE
    <ul>
      <li>mTransactionHandler.handleLaunchActivity(r, mPendingActions,null /* customIntent */);</li>
      <li>æ­¤å¤„çš„ mTransactionHandler å˜é‡æ˜¯è°å‘¢ï¼Ÿ</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>// TransactionExecutor.java

    public TransactionExecutor(ClientTransactionHandler clientTransactionHandler) {
        mTransactionHandler = clientTransactionHandler;
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>// ActivityThread

private final TransactionExecutor mTransactionExecutor = new TransactionExecutor(this);
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ ActivityThread å†…å®ä¾‹åŒ–ï¼Œæ‰€ä»¥ mTransactionHandler å°±æ˜¯ ActivityThreadã€‚<br />
æ¥ç€è°ƒç”¨ mTransactionHandler.handleLaunchActivityï¼Œå³ ActivityThread#handleLaunchActivity<br /></p>

<ul>
  <li>
    <p>ActivityThread#handleLaunchActivity</p>
  </li>
  <li>
    <p>ActivityThread#performLaunchActivity</p>

    <ul>
      <li>
        <p>mInstrumentation.callActivityOnCreate</p>

        <ul>
          <li>activity.performCreate</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Activity#performCreate</p>

    <ul>
      <li>onCreate // è§¦å‘äº†ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€ä¸ªå‡½æ•° onCreate</li>
    </ul>
  </li>
</ul>

:ET