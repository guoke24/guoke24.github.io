I"Á<<h1 id="å‰è¨€">å‰è¨€</h1>
<p>ç”±è¯¥æ–‡ç« ï¼š [[Activity çš„æ ¹è§†å›¾ â€“ DecorView çš„æ„æˆ ]] ï¼Œå¯çŸ¥ï¼Œ
ä¸€ä¸ª Activity æŒæœ‰ ä¸€ä¸ª PhoneWindow ç±»å¯¹è±¡ï¼Œ
PhoneWindow ç±»å¯¹è±¡å†…çš„ mDecor å˜é‡ï¼Œå°±æ˜¯ Activity çš„æ ¹è§†å›¾ DecorView å®ä¾‹ã€‚</p>

<p>å‰æçŸ¥è¯†äº¤ä»£å®Œæ¯•ã€‚</p>
<h1 id="æ¦‚è§ˆ">æ¦‚è§ˆ</h1>

<p>å½“æ–°å»ºä¸€ä¸ªActivity çš„æ—¶å€™ï¼ŒActivityManagerService(ç®€ç§° AMS) ä¼šé€šè¿‡ Binder æœºåˆ¶ï¼Œ
è·¨è¿›ç¨‹é€šè®¯ï¼Œè°ƒç”¨åˆ° ActivityThread#H#handleMessage â€“&gt; ActivityThread çš„ handleLaunchActivity å‡½æ•°ï¼Œç„¶åæ‰§è¡Œ handleResumeActivity å‡½æ•°ã€‚</p>

<ul>
  <li>
    <p>ActivityThread#handleLaunchActivity
Activity å†…çš„ PhoneWindow å®ä¾‹å†…çš„ DecorView å®ä¾‹ï¼Œåˆ›å»ºå®Œæˆ<br /></p>
  </li>
  <li>
    <p>ActivityThread#handleResumeActivity
åˆ›å»º ViewRootImpl å®ä¾‹ï¼ŒDecorView å®ä¾‹çš„å¼•ç”¨ä¼ é€’ç»™å…¶å†…éƒ¨çš„ mView å˜é‡ï¼Œç„¶åæ‰§è¡Œ ViewRootImpl#requestLayout å‡½æ•°ï¼Œå¼€å§‹ View çš„å·¥ä½œæµç¨‹ã€‚</p>
  </li>
</ul>

<p><br />
æ¥ç€ä» handleLaunchActivity å‡½æ•°å¼€å§‹çœ‹ã€‚</p>

<h1 id="handlelaunchactivity">handleLaunchActivity</h1>

<ul>
  <li>ActivityThread#handleLaunchActivity
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  WindowManagerGlobal.initialize();

      final Activity a = performLaunchActivity(r, customIntent);
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><br /></p>
  </li>
  <li>ActivityThread#performLaunchActivity
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>if (r.isPersistable()) {
  mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);
 } else {
  mInstrumentation.callActivityOnCreate(activity, r.state);
 }
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><br /></p>
  </li>
  <li>Instrumentation#callActivityOnCreate
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>      prePerformCreate(activity);
      activity.performCreate(icicle);
      postPerformCreate(activity);
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><br /></p>
  </li>
  <li>Activity#performCreate
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  if (persistentState != null) {
          onCreate(icicle, persistentState);
      } else {
          onCreate(icicle);
      }
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>Activity#onCreate</li>
</ul>

<p><strong>å°èŠ‚ä¸€ä¸‹</strong><br />
åˆ°æ­¤å¯çŸ¥ï¼ŒActivityThread#handleLaunchActivity å‡½æ•°ï¼Œä¼šè§¦å‘ Activity#onCreate å‡½æ•°ï¼Œ
æ¥ç€è°ƒç”¨ setContent å‡½æ•°ï¼Œæ¥ä¸‹æ¥çš„è°ƒç”¨é“¾å¯ä»¥å‚è€ƒ [[Activity çš„æ ¹è§†å›¾ â€“ DecorView]] ï¼Œç»“æœå°±æ˜¯ï¼š
Activity å†…çš„ PhoneWindow å®ä¾‹å†…çš„ DecorView å®ä¾‹ï¼Œåœ¨æ­¤æ—¶åˆ›å»ºã€‚
å¹¶é€šè¿‡ Activity#onCreate å†…è°ƒç”¨ setContentView å‡½æ•°ï¼Œæ„é€ ä»¥ DecorView ä¸ºæ ¹çš„è§†å›¾æ ‘ ViewTree ã€‚
åœ¨ Activity ä¸­ï¼Œå¯é€šè¿‡ getWindow().getDecorView() æ¥è·å¾— DecorView ç±»å®ä¾‹ã€‚</p>

<h5 id="æœ¬å°èŠ‚è°ƒç”¨é“¾">æœ¬å°èŠ‚è°ƒç”¨é“¾ï¼š</h5>
<ul>
  <li>ActivityThread#handleLaunchActivity</li>
  <li>ActivityThread#performLaunchActivity</li>
  <li>Instrumentation#callActivityOnCreate</li>
  <li>Activity#performCreate</li>
  <li>Activity#onCreate</li>
</ul>

<p><br />
DecorView ç±»å®ä¾‹åˆ›å»ºå®Œæˆåï¼Œå°±éœ€è¦å¼€å§‹å·¥ä½œæµç¨‹äº†ã€‚åœ¨å“ªé‡Œå¼€å§‹çš„å‘¢ï¼Ÿ</p>

<p>å½“ ActivityThread çš„ handleLaunchActivity å‡½æ•°æ‰§è¡Œå®Œä¹‹åï¼ŒhandleResumeActivity ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œè¯¥å‡½æ•°ä¼šå¯¼è‡´è§†å›¾æ ‘çš„å·¥ä½œæµç¨‹çš„å¼€å§‹ã€‚
æˆ‘ä»¬ä» ActivityThread çš„ handleResumeActivity å‡½æ•°å¼€å§‹çœ‹ã€‚</p>

<h1 id="handleresumeactivity">handleResumeActivity</h1>
<ul>
  <li>ActivityThread#handleResumeActivity
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>  View decor = r.window.getDecorView();
  // ç•¥ã€‚ã€‚ã€‚
  ViewManager wm = a.getWindowManager();
  WindowManager.LayoutParams l = r.window.getAttributes();
  // ç•¥ã€‚ã€‚ã€‚
  wm.addView(decor, l);
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><br /></p>
  </li>
  <li>WindowManagerImpl#addView</li>
  <li>WindowManagerGlobal#addView
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  root = new ViewRootImpl(view.getContext(), display);
  // ç•¥ã€‚ã€‚ã€‚
  try {
              root.setView(view, wparams, panelParentView);
      }
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><br /></p>
  </li>
  <li>ViewRootImpl#setView
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {
    synchronized (this) {
  if (mView == null) {
      mView = view;

      mWindowAttributes.copyFrom(attrs);
      // ç•¥ã€‚ã€‚ã€‚
      // Schedule the first layout -before- adding to the window
      // manager, to make sure we do the relayout before receiving
      // any other events from the system.
      requestLayout();
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ViewRootImpl#requestLayout
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  // å¼€å§‹ View çš„å·¥ä½œæµç¨‹
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<p><strong>å°èŠ‚ä¸€ä¸‹</strong><br />
åˆ°æ­¤å¯çŸ¥ï¼ŒActivityThread#handleResumeActivity ä¼šè°ƒç”¨åˆ° ViewRootImpl#setViewï¼Œ
åœ¨æ­¤æœŸé—´ï¼Œåˆ›å»º ViewRootImpl å®ä¾‹ï¼ŒæŠŠåˆ›å»ºå¥½çš„ DecorView å®ä¾‹ï¼Œä¼ é€’ç»™ ViewRootImpl å®ä¾‹ï¼Œäº¤ç»™å…¶å†…éƒ¨çš„ mView å˜é‡å¼•ç”¨ï¼Œç„¶åæ‰§è¡Œ ViewRootImpl#requestLayout å‡½æ•°ï¼Œå¼€å§‹ View çš„å·¥ä½œæµç¨‹ã€‚</p>

<h5 id="æœ¬å°èŠ‚è°ƒç”¨é“¾-1">æœ¬å°èŠ‚è°ƒç”¨é“¾ï¼š</h5>
<ul>
  <li>ActivityThread#handleResumeActivity</li>
  <li>WindowManagerImpl#addView</li>
  <li>WindowManagerGlobal#addView</li>
  <li>ViewRootImpl#setView</li>
  <li>ViewRootImpl#requestLayout</li>
</ul>

<p>æ¥ç€çœ‹ ViewRootImpl#requestLayout å‡½æ•°ã€‚</p>

<h3 id="requestlayout">requestLayout</h3>
<ul>
  <li>ViewRootImpl#requestLayout
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>  @Override
  public void requestLayout() {
      if (!mHandlingLayoutInLayoutRequest) {
          checkThread();
          mLayoutRequested = true;
          scheduleTraversals();
      }
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ViewRootImpl#scheduleTraversals
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>  void scheduleTraversals() {
      if (!mTraversalScheduled) {
          mTraversalScheduled = true;
          mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();
          mChoreographer.postCallback(
                  Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable/*æ¥ç€è¿™çœ‹*/, null);

  // ......
      }
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ViewRootImpl#mTraversalRunnable
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>  final TraversalRunnable mTraversalRunnable = new TraversalRunnable();

  final class TraversalRunnable implements Runnable {
      @Override
      public void run() {
          doTraversal();
      }
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ViewRootImpl#doTraversal
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>  void doTraversal() {
      if (mTraversalScheduled) {
          mTraversalScheduled = false;
          mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);

     // ã€‚ã€‚ã€‚

          performTraversals();// æ­¤å¤„è§¦å‘ä¸‰å¤§æµç¨‹ 
	  
     // ã€‚ã€‚ã€‚
      }
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>ViewRootImpl#performTraversals
```
  boolean newSurface = false;
  WindowManager.LayoutParams lp = mWindowAttributes;
  Rect frame = mWinFrame;</p>

    <p>if (mWidth != frame.width() || mHeight != frame.height()) {
      mWidth = frame.width();
      mHeight = frame.height();
  }
  int childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);
  int childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>// â€”â€”â€”â€”â€”â€”â€”- åˆ†å‰²çº¿ â€”â€”â€”â€”â€”â€”â€”-</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  final boolean didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);
  if (didLayout) {
      performLayout(lp, mWidth, mHeight);
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>// â€”â€”â€”â€”â€”â€”â€”- åˆ†å‰²çº¿ â€”â€”â€”â€”â€”â€”â€”-</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>          if (!hadSurface) {
              if (mSurface.isValid()) {
                  newSurface = true;
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>// ç•¥ã€‚ã€‚ã€‚
      if (!cancelDraw &amp;&amp; !newSurface) {
          performDraw();</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>
- ViewRootImpl#performMeasure
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); ```
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>ViewRootImpl#performLayout
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>  final View host = mView;

  host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());

  mInLayout = false;
  int numViewsRequestingLayout = mLayoutRequesters.size();
  if (numViewsRequestingLayout &gt; 0) {
       // ã€‚ã€‚ã€‚
      ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters (mLayoutRequesters,false);

       if (validLayoutRequesters != null) {
         // ã€‚ã€‚ã€‚
         mInLayout = true;
         host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());
         // ã€‚ã€‚ã€‚
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ViewRootImpl#performDraw</li>
  <li>ViewRootImpl#draw</li>
  <li>ViewRootImpl#drawSoftware
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  mView.draw(canvas);
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<p><strong>å°èŠ‚ä¸€ä¸‹</strong><br />
requestLayout å‡½æ•°ï¼Œä¼šè§¦å‘ View å·¥ä½œçš„ä¸‰å¤§æµç¨‹ã€‚
performTraversals å‡½æ•°ï¼Œ800è¡Œå·¦å³çš„ä»£ç ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å…¶å†…éƒ¨è§¦å‘ä¸‰å¤§æµç¨‹ performMeasureï¼ŒperformLayoutï¼ŒperformDraw å³å¯ã€‚è¯¦ç»†æºç ï¼Œ[å¯å‚è€ƒ] ( https://www.androidos.net.cn/android/8.0.0_r4/xref/frameworks/base/core/java/android/view/ViewRootImpl.java )ã€‚
<br /></p>
<h5 id="æœ¬å°èŠ‚è°ƒç”¨é“¾-2">æœ¬å°èŠ‚è°ƒç”¨é“¾ï¼š</h5>
<ul>
  <li>ViewRootImpl#setView</li>
  <li>ViewRootImpl#requestLayout</li>
  <li>ViewRootImpl#scheduleTraversals</li>
  <li>mChoreographer.postCallback( â€¦ , mTraversalRunnable , â€¦)</li>
  <li>ViewRootImpl#TraversalRunnable.run</li>
  <li>ViewRootImpl#doTraversal</li>
  <li>ViewRootImpl#performTraversals</li>
  <li>ViewRootImpl#performMeasure -&gt; DecorView#measure</li>
  <li>ViewRootImpl#performLayout -&gt; DecorView#layout</li>
  <li>ViewRootImpl#performDraw -&gt; draw -&gt; drawSoftware -&gt; DecorView#draw</li>
</ul>

<h1 id="è°ƒç”¨é“¾æ±‡æ€»">è°ƒç”¨é“¾æ±‡æ€»</h1>
<ul>
  <li>
    <p>AMS#startActivityAsUser â€¦â€¦</p>
  </li>
  <li>
    <p>ActivityThread#H#handleMessage â€¦â€¦</p>
  </li>
  <li>ActivityThread#handleLaunchActivity
    <ul>
      <li>ActivityThread#performLaunchActivity</li>
      <li>Instrumentation#callActivityOnCreate</li>
      <li>Activity#performCreate</li>
      <li>Activity#onCreate</li>
    </ul>
  </li>
  <li>ActivityThread#handleResumeActivity
    <ul>
      <li>WindowManagerImpl#addView</li>
      <li>WindowManagerGlobal#addView</li>
      <li>ViewRootImpl#setView</li>
      <li>ViewRootImpl#requestLayout</li>
      <li>ViewRootImpl#scheduleTraversals</li>
      <li>mChoreographer.postCallback( â€¦ , mTraversalRunnable , â€¦)</li>
      <li>ViewRootImpl#TraversalRunnable.run</li>
      <li>ViewRootImpl#doTraversal</li>
      <li>ViewRootImpl#performTraversals
        <ul>
          <li>ViewRootImpl#performMeasure -&gt; DecorView#measure</li>
          <li>ViewRootImpl#performLayout -&gt; DecorView#layout</li>
          <li>ViewRootImpl#performDraw -&gt; draw -&gt; drawSoftware -&gt; DecorView#draw</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

:ET