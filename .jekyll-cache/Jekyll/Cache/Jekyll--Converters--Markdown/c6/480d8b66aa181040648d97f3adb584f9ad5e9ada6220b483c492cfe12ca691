I"œx<h1 id="å‰è¨€">å‰è¨€</h1>
<p>å‚è€ƒæ–‡ç« ï¼š 
[å‡¶æ®‹çš„ç¨‹åºå‘˜-View çš„å·¥ä½œæµç¨‹] ( https://blog.csdn.net/qian520ao/article/details/78657084 )
[Android æºç åˆ†æ - Viewçš„measureã€layoutã€drawä¸‰å¤§æµç¨‹] ( https://www.jianshu.com/p/aa3b1f9717b7 )
[æ·±å…¥ç†è§£MeasureSpec] ( https://www.jianshu.com/p/a790982fd20e )
æœ¬æ–‡ç« çš„æºç ï¼Œå¯ä»¥å»è¯¥é“¾æ¥ <a href="https://www.androidos.net.cn/android/9.0.0_r8/xref"> Android9.0 - API28 </a>  ç›´æ¥æœç´¢ï¼Œæµè§ˆã€‚
æˆ–è€… AndroidStudio æŸ¥çœ‹ sdk ä¸­ /sdk/sources/android-28/android è·¯å¾„ä¸‹çš„æºç ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p>

<h1 id="viewçš„ä¸‰å¤§å·¥ä½œæµç¨‹">Viewçš„ä¸‰å¤§å·¥ä½œæµç¨‹</h1>
<p>ç”±æ–‡ç«   [[Viewçš„å·¥ä½œæµç¨‹çš„æºå¤´]]  å¯çŸ¥ï¼Œ</p>

<hr />
<p>ActivityThread#handleResumeActivity å‡½æ•°<br />
åˆ›å»º ViewRootImpl å®ä¾‹ï¼ŒDecorView å®ä¾‹çš„å¼•ç”¨ä¼ é€’ç»™å…¶å†…éƒ¨çš„ mView å˜é‡ï¼Œç„¶åæ‰§è¡Œ ViewRootImpl#requestLayout å‡½æ•°ï¼Œå¼€å§‹ View çš„å·¥ä½œæµç¨‹ã€‚<br />
requestLayout å‡½æ•°ï¼Œä¼šè§¦å‘ View å·¥ä½œçš„ä¸‰å¤§æµç¨‹ï¼šmeasureï¼Œlayoutï¼Œdrawã€‚<br />
è°ƒç”¨é“¾ï¼š<br />
â€“&gt; ActivityThread#handleResumeActivity â€¦â€¦ <br />
â€“&gt; ViewRootImpl#setView<br />
â€“&gt; ViewRootImpl#requestLayout<br />
â€“&gt; ViewRootImpl#scheduleTraversals<br />
â€“&gt; mChoreographer.postCallback( â€¦ , mTraversalRunnable , â€¦)<br />
â€“&gt; ViewRootImpl#TraversalRunnable.run<br />
â€“&gt; ViewRootImpl#doTraversal<br />
â€“&gt; ViewRootImpl#performTraversals<br />
â€“&gt; ViewRootImpl#performMeasure -&gt; DecorView#measure<br />
â€“&gt; ViewRootImpl#performLayout -&gt; DecorView#layout<br />
â€“&gt; ViewRootImpl#performDraw -&gt; draw -&gt; drawSoftware -&gt; DecorView#draw<br /></p>

<hr />

<h1 id="ç¬¬äºŒå¤§æµç¨‹å¸ƒå±€">ç¬¬äºŒå¤§æµç¨‹ï¼šå¸ƒå±€</h1>
<p>ç”± [[Viewçš„å·¥ä½œæµç¨‹çš„æºå¤´]] å¯çŸ¥ï¼Œä¸€ä¸ª Activity åˆ›å»ºä¹‹åï¼Œé€šè¿‡è¯¥è°ƒç”¨é“¾ï¼š</p>
<ul>
  <li>ActivityThread#handleResumeActivity</li>
  <li>ViewRootImpl#requestLayout</li>
  <li>ViewRootImpl#performTraversals</li>
  <li>ViewRootImpl#performMeasure -&gt; DecorView#measure</li>
  <li>ViewRootImpl#performLayout -&gt; DecorView#layout
å…ˆæ‰§è¡Œäº†æµ‹é‡æµç¨‹ï¼Œç­‰æµ‹é‡æµç¨‹æ‰§è¡Œå®Œä¹‹åï¼Œæ¯ä¸ª View éƒ½å®Œæˆäº†å¯¹è‡ªå·±çš„æµ‹é‡ï¼Œæµ‹é‡ç»“æœä¿å­˜åœ¨ mMeasuredWidthï¼ŒmMeasuredHeight  å˜é‡ã€‚
æµ‹å‡ºæ¯ä¸ª View çš„å¤§å°ä¹‹åï¼Œæ¥ç€å°±æ˜¯æ‰§è¡Œå¸ƒå±€æµç¨‹ï¼Œç¡®å®šæ¯ä¸ª View çš„ä½ç½®äº†ã€‚</li>
</ul>

<h1 id="æ­¥éª¤æ¦‚è§ˆ">æ­¥éª¤æ¦‚è§ˆï¼š</h1>
<ul>
  <li>ç¬¬é›¶æ­¥ï¼ŒViewRootImpl#performTraversals
    <ul>
      <li>è‹¥è¯·æ±‚äº†ç»˜åˆ¶ï¼Œå¹¶ä¸” ã€Œçª—å£æ´»åŠ¨ã€ æˆ– ã€ŒæŠ¥å‘Šäº†ä¸‹ä¸€æ¬¡ç»˜åˆ¶ã€ ï¼Œå°±ä¼šæ‰§è¡Œ performLayout å‡½æ•°</li>
    </ul>
  </li>
  <li>ç¬¬ä¸€æ­¥ï¼ŒViewRootImpl#performLayout
    <ul>
      <li>host.layout</li>
    </ul>
  </li>
  <li>ç¬¬äºŒæ­¥ï¼ŒDecorView-ViewGroup#layou
    <ul>
      <li>mTransition.layoutChange</li>
      <li>super.layout â€“ View#layou
        <ul>
          <li>setFrame è®¾ç½®è‡ªèº«å¸ƒå±€</li>
          <li>onLayout</li>
          <li>listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB);</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ç¬¬ä¸‰æ­¥ï¼ŒDecorView#onLayout
    <ul>
      <li>super.onLayout â€“ FrameLayout#onLayout
        <ul>
          <li>FrameLayout#layoutChildren ï¼šchild.layout</li>
        </ul>
      </li>
      <li>å¤„ç† outsets ï¼Ÿ</li>
    </ul>
  </li>
  <li>ç¬¬å››æ­¥ï¼Œæ™®é€šViewGroupçš„å­ç±»-View#layout
    <ul>
      <li>setFrame è®¾ç½®è‡ªèº«å¸ƒå±€</li>
      <li>onLayout</li>
      <li>listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB);</li>
    </ul>
  </li>
  <li>ç¬¬äº”æ­¥ï¼Œæ™®é€šViewGroupçš„å­ç±»#onLayout
    <ul>
      <li>æ ¹æ®è‡ªèº«å¸ƒå±€ç‰¹ç‚¹ï¼Œè®¡ç®— child çš„ä½ç½®ï¼Œchild.layout è§¦å‘ child çš„å¸ƒå±€æµç¨‹</li>
      <li>LinearLayout ä¸ºä¾‹
        <ul>
          <li>LinearLayout#onLayoutï¼ˆè´Ÿè´£æ ¹æ®ä¸åŒå¸ƒå±€ï¼Œè®¡ç®—å‡ºå­ View ä½ç½®ï¼‰</li>
          <li>LinearLayout#layoutVertical</li>
          <li>forï¼šLinearLayout#setChildFrame â€“ child.layout</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ç¬¬å…­æ­¥ï¼Œæ™®é€šViewçš„å­ç±»-View#layout
    <ul>
      <li>setFrame è®¾ç½®è‡ªèº«å¸ƒå±€</li>
      <li>onLayout</li>
      <li>listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB);</li>
    </ul>
  </li>
  <li>ç¬¬ä¸ƒæ­¥ï¼Œæ™®é€šViewçš„å­ç±»#onLayout
    <ul>
      <li>ä»¥ TextView ä¸ºä¾‹</li>
      <li>TextView#onLayout</li>
      <li>super.onLayout</li>
      <li>å¢åŠ äº†bringPointIntoView å’Œ autoSizeText ä¸¤ä¸ªåŠŸèƒ½</li>
    </ul>
  </li>
</ul>

<h1 id="å¸ƒå±€æ­¥éª¤æºç è¯¦è§£">å¸ƒå±€æ­¥éª¤æºç è¯¦è§£ï¼š</h1>
<h2 id="ç¬¬é›¶æ­¥viewrootimplperformtraversals">ç¬¬é›¶æ­¥ï¼ŒViewRootImpl#performTraversals</h2>
<p>æºç æ®µ0:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>// ViewRootImpl ç±»

    private void performTraversals() {
        // cache mView since it is used so much below...
        final View host = mView;

	// ã€‚ã€‚ã€‚

        final boolean didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);

        if (didLayout) {
            performLayout(lp, mWidth, mHeight);
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ç”±æ­¤æ®µä»£ç å¯è§ï¼ŒperformLayout çš„æ‰§è¡Œï¼Œå—åˆ° layoutRequestedï¼ŒmStopped å’Œ mReportNextDraw ä¸‰ä¸ªå˜é‡çš„å½±å“ã€‚è¿½è¸ªä¸€ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>        boolean layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>mLayoutRequested å˜é‡
åœ¨æ‰§è¡Œ requestLayout å‡½æ•°æ—¶è¢«è®¾ç½®ä¸º trueï¼Œè¯´æ˜è¯·æ±‚äº†å¸ƒå±€ã€‚
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>  @Override
  public void requestLayout() {
      if (!mHandlingLayoutInLayoutRequest) {
          checkThread();
          mLayoutRequested = true;
          scheduleTraversals();
      }
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>mStopped å˜é‡é»˜è®¤å€¼ä¸º false
åœ¨æ‰§è¡Œ setWindowStopped å‡½æ•°æ—¶è¢«è®¾ç½®ï¼Œè¯¥å˜é‡åº”è¯¥è·Ÿ Activity çš„ç”Ÿå‘½å‘¨æœŸæœ‰å…³è”ã€‚mStopped ä¸º falseï¼Œè¯´æ˜è¯¥çª—å£æ—¶æ´»åŠ¨çš„ã€‚
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>  // Set to true if the owner of this window is in the stopped state,
  // so the window should no longer be active.
  boolean mStopped = false;

  void setWindowStopped(boolean stopped) {
      if (mStopped != stopped) {
          mStopped = stopped;
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>mReportNextDraw å˜é‡
ä»å­—é¢ä¸Šçœ‹ï¼Œè¡¨ç¤ºæŠ¥å‘Šäº†ä¸‹ä¸€æ¬¡ç»˜åˆ¶ã€‚
mReportNextDraw åœ¨æ‰§è¡Œ reportNextDraw å‡½æ•°æ—¶è¢«è®¾ç½®ä¸º trueã€‚
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>  private void reportNextDraw() {
      if (mReportNextDraw == false) {
          drawPending();
      }
      mReportNextDraw = true;
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ç»¼åˆä»¥ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç®€å•ä¸”ä¸ä¸¥è°¨çš„ç»“è®ºï¼š
åªæœ‰å½“è¯·æ±‚äº†ç»˜åˆ¶ï¼ˆmLayoutRequested == trueï¼‰ï¼Œ
è€Œä¸” è¯¥çª—å£å¤„äºæ´»åŠ¨çŠ¶æ€ï¼ˆmStopped == falseï¼‰æˆ–è€… 
æŠ¥å‘Šäº†ä¸‹ä¸€æ¬¡ç»˜åˆ¶ï¼ˆmReportNextDraw == trueï¼‰çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ‰§è¡Œ performLayout å‡½æ•°ã€‚<br /></li>
</ul>

<p>æ¥ç€è¿½è¸ªä¸€ä¸‹ performLayout å‡½æ•°çš„è¿™ä¸‰å…¥å‚ lp, mWidth, mHeightï¼Œæ¥ç€æºç æ®µ0ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>// ViewRootImpl ç±»

    private void performTraversals() {

        WindowManager.LayoutParams lp = mWindowAttributes;
        Rect frame = mWinFrame;

        if (mFirst || windowShouldResize ||insetsChanged ||viewVisibilityChanged || params != null ||mForceNextWindowRelayout) 
       {

	     // ã€‚ã€‚ã€‚

            if (mWidth != frame.width() || mHeight != frame.height()) {
                mWidth = frame.width();
                mHeight = frame.height();
            }
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>mWindowAttributes å˜é‡
æ¥è‡ªäº Activity æŒæœ‰çš„ PhoneWindow å®ä¾‹çš„ getAttributes() å‡½æ•°ï¼Œè¡¨ç¤ºçª—å£çš„å±æ€§ã€‚è§å¦‚ä¸‹å‡½æ•°ï¼šActivityThread#handleResumeActivity
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>  View decor = r.window.getDecorView();
  // ç•¥ã€‚ã€‚ã€‚
  ViewManager wm = a.getWindowManager();
  WindowManager.LayoutParams l = r.window.getAttributes();
  // ç•¥ã€‚ã€‚ã€‚
  wm.addView(decor, l);
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>mWinFrame å˜é‡
ä¿å­˜ WindowManagerService ä¿®æ”¹åçš„Activityçª—å£çš„å®½åº¦å’Œé«˜åº¦ã€‚
å¼•ç”¨å‚è€ƒè¯¥é“¾æ¥ï¼šhttps://blog.csdn.net/wangaiji/article/details/98210394
    <blockquote>
      <p>æ³¨æ„ï¼ViewRootç±»çš„å¦å¤–ä¸¤ä¸ªæˆå‘˜å˜é‡mWidthå’ŒmHeightä¹Ÿæ˜¯ç”¨æ¥æè¿°Activityçª—å£å½“å‰çš„å®½åº¦å’Œé«˜åº¦çš„ï¼Œä½†æ˜¯å®ƒä»¬çš„å€¼æ˜¯ç”±åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸Šä¸€æ¬¡ä¸»åŠ¨è¯·æ±‚WindowManagerServiceæœåŠ¡è®¡ç®—å¾—åˆ°çš„ï¼Œå¹¶ä¸”ä¼šä¸€ç›´ä¿æŒä¸å˜åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸‹ä¸€æ¬¡å†è¯·æ±‚WindowManagerServiceæœåŠ¡æ¥é‡æ–°è®¡ç®—ä¸ºæ­¢ã€‚Activityçª—å£çš„å½“å‰å®½åº¦å’Œé«˜åº¦æœ‰æ—¶å€™æ˜¯è¢«WindowManagerServiceæœåŠ¡ä¸»åŠ¨è¯·æ±‚åº”ç”¨ç¨‹åºè¿›ç¨‹ä¿®æ”¹çš„ï¼Œä¿®æ”¹åçš„å€¼å°±ä¼šä¿å­˜åœ¨ViewRootç±»çš„æˆå‘˜å˜é‡mWinFrameä¸­ï¼Œå®ƒä»¬å¯èƒ½ä¼šä¸ViewRootç±»çš„æˆå‘˜å˜é‡mWidthå’ŒmHeightçš„å€¼ä¸åŒã€‚
<br /></p>
    </blockquote>
  </li>
  <li>ç¬¬é›¶æ­¥å°èŠ‚
ViewRootImpl çš„ performTraversals ä¸­ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªå‚æ•°æ§åˆ¶ç€ performLayout æ˜¯å¦è¢«æ‰§è¡Œï¼Œè‹¥è¯·æ±‚äº†ç»˜åˆ¶ï¼Œå¹¶ä¸”åœ¨ ã€Œçª—å£æ´»åŠ¨ã€ æˆ– ã€ŒæŠ¥å‘Šäº†ä¸‹ä¸€æ¬¡ç»˜åˆ¶ã€ ä¸¤ä¸ªæ¡ä»¶æ»¡è¶³ä¸€ä¸ªçš„æ¡ä»¶ä¸‹ï¼Œå°±ä¼šæ‰§è¡Œ performLayout å‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°è·Ÿçª—å£çš„å±æ€§æœ‰å…³ã€‚</li>
</ul>

<h2 id="ç¬¬ä¸€æ­¥viewrootimplperformlayout">ç¬¬ä¸€æ­¥ï¼ŒViewRootImpl#performLayout</h2>
<p>æºç æ®µ1:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>// ViewRootImpl ç±»

    private void performLayout(WindowManager.LayoutParams lp, int desiredWindowWidth,
            int desiredWindowHeight) {
        mLayoutRequested = false;
        mScrollMayChange = true;
        mInLayout = true;

        final View host = mView;

        try {
            host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ¯”è¾ƒç®€å•çš„è°ƒç”¨äº† DecorView çš„ layou å‡½æ•°ï¼Œæµç¨‹ç»§ç»­ã€‚</p>

<h2 id="ç¬¬äºŒæ­¥decorview-viewgrouplayou">ç¬¬äºŒæ­¥ï¼ŒDecorView-ViewGroup#layou</h2>
<p>DecorView ç±»æ²¡æœ‰å®ç° layout å‡½æ•°ï¼Œç›´æ¥ä½¿ç”¨çˆ¶ç±» ViewGroup çš„ layou å‡½æ•°ã€‚
æºç æ®µ2:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>// ViewGroup ç±»

    @Override
    public final void layout(int l, int t, int r, int b) {
        if (!mSuppressLayout &amp;&amp; (mTransition == null || !mTransition.isChangingLayout())) {
            if (mTransition != null) {
                mTransition.layoutChange(this);
            }
            super.layout(l, t, r, b);
        } else {
            // record the fact that we noop'd it; request layout when transition finishes
            mLayoutCalledWhileSuppressed = true;
        }
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>é€šçŸ¥äº†è§‚å¯Ÿè€…ï¼Œç„¶åè°ƒç”¨ super.layout(l, t, r, b)ï¼›å³ View#layou å‡½æ•°ã€‚</p>

<h3 id="viewlayou-æºç ">View#layou æºç </h3>
<p>æºç æ®µ2.1:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre>// Viewç±»

    /**
     * Assign a size and position to a view and all of its
     * descendants
     *
     *
     * @param l Left position, relative to parent
     * @param t Top position, relative to parent
     * @param r Right position, relative to parent
     * @param b Bottom position, relative to parent
     */
    @SuppressWarnings({"unchecked"})
    public void layout(int l, int t, int r, int b) {
        if ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != 0) {
            onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);
            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;
        }

        int oldL = mLeft;
        int oldT = mTop;
        int oldB = mBottom;
        int oldR = mRight;

        boolean changed = isLayoutModeOptical(mParent) ?
                setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);

        if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) {
            onLayout(changed, l, t, r, b);

	    // ã€‚ã€‚ã€‚
	    
            // é€šçŸ¥è§‚å¯Ÿè€…
            ListenerInfo li = mListenerInfo;
            if (li != null &amp;&amp; li.mOnLayoutChangeListeners != null) {
                ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =
                        (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();
                int numListeners = listenersCopy.size();
                for (int i = 0; i &lt; numListeners; ++i) {
                    listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB);
                }
            }
        }

    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ View#layou å‡½æ•°çš„å¼€å¤´å°±éå¸¸ç›´æ¥çš„è°ƒç”¨ setFrame å‡½æ•°ï¼Œè®¾ç½®å¸ƒå±€çš„å››ä¸ªå…³é”®æ•°å€¼ï¼šmLeftï¼ŒmTopï¼ŒmBottomï¼ŒmRightã€‚setOpticalFrame å‡½æ•°æœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨ setFrame å‡½æ•°ã€‚</p>

<h3 id="viewsetframe-æºç ">View#setFrame æºç </h3>
<p>ä»£ç æ®µ2.2ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre>// Viewç±»

    /**
     * Assign a size and position to this view.
     *
     * This is called from layout.
     *
     * @param left Left position, relative to parent
     * @param top Top position, relative to parent
     * @param right Right position, relative to parent
     * @param bottom Bottom position, relative to parent
     * @return true if the new size and position are different than the
     *         previous ones
     * {@hide}
     */
    protected boolean setFrame(int left, int top, int right, int bottom) {
        boolean changed = false;

        if (DBG) {
            Log.d(VIEW_LOG_TAG, this + " View.setFrame(" + left + "," + top + ","
                    + right + "," + bottom + ")");
        }

        if (mLeft != left || mRight != right || mTop != top || mBottom != bottom) {
            changed = true;

            // Remember our drawn bit
            int drawn = mPrivateFlags &amp; PFLAG_DRAWN;

            int oldWidth = mRight - mLeft;
            int oldHeight = mBottom - mTop;
            int newWidth = right - left;
            int newHeight = bottom - top;
            boolean sizeChanged = (newWidth != oldWidth) || (newHeight != oldHeight);

            // Invalidate our old position
            invalidate(sizeChanged);

            mLeft = left;
            mTop = top;
            mRight = right;
            mBottom = bottom;
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿™å››ä¸ªå…¥å‚ï¼Œè¡¨ç¤ºå­æ§ä»¶å¯¹äºçˆ¶æ§ä»¶å››ä¸ªè¾¹çš„è·ç¦»ï¼Œåœ¨ View ç±»ä¸­ç”¨å››ä¸ªå˜é‡ä¿å­˜ï¼šmLeftï¼ŒmTopï¼ŒmBottomï¼ŒmRightã€‚<br />
å†å›åˆ° View#layou å‡½æ•°ï¼Œæ‰§è¡Œå®Œ setFrame å‡½æ•°åï¼Œè¡¨ç¤ºå¸ƒå±€å·²ç»ç¡®å®šï¼Œæ¥ç€è°ƒç”¨ onLayout å‡½æ•°ï¼Œæµç¨‹ç»§ç»­ã€‚</p>

<h2 id="ç¬¬ä¸‰æ­¥decorviewonlayout">ç¬¬ä¸‰æ­¥ï¼ŒDecorView#onLayout</h2>

<p>ä»£ç æ®µ3ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>// DecorView ç±»

    @Override
    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {
	// å³è°ƒç”¨ FrameLayout çš„ onLayout å‡½æ•°
        super.onLayout(changed, left, top, right, bottom); 
        getOutsets(mOutsets);
        if (mOutsets.left &gt; 0) {
            offsetLeftAndRight(-mOutsets.left);
        }
        if (mOutsets.top &gt; 0) {
            offsetTopAndBottom(-mOutsets.top);
        }
        if (mApplyFloatingVerticalInsets) {
            offsetTopAndBottom(mFloatingInsets.top);
        }
        if (mApplyFloatingHorizontalInsets) {
            offsetLeftAndRight(mFloatingInsets.left);
        }

        // If the application changed its SystemUI metrics, we might also have to adapt
        // our shadow elevation.
        updateElevation();
        mAllowUpdateElevation = true;

        if (changed &amp;&amp; mResizeMode == RESIZE_MODE_DOCKED_DIVIDER) {
            getViewRootImpl().requestInvalidateRootRenderNode();
        }
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç æ®µ3.1ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>//  FrameLayout ç±»

    @Override
    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {
        layoutChildren(left, top, right, bottom, false /* no force left gravity */);
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç æ®µ3.2ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre>//  FrameLayout ç±»

    void layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity) {
        final int count = getChildCount();

        final int parentLeft = getPaddingLeftWithForeground();
        final int parentRight = right - left - getPaddingRightWithForeground();

        final int parentTop = getPaddingTopWithForeground();
        final int parentBottom = bottom - top - getPaddingBottomWithForeground();

        for (int i = 0; i &lt; count; i++) {
            final View child = getChildAt(i);
            if (child.getVisibility() != GONE) {
                final LayoutParams lp = (LayoutParams) child.getLayoutParams();

                final int width = child.getMeasuredWidth();
                final int height = child.getMeasuredHeight();

                int childLeft;
                int childTop;

                int gravity = lp.gravity;
                if (gravity == -1) {
                    gravity = DEFAULT_CHILD_GRAVITY;
                }

                final int layoutDirection = getLayoutDirection();
                final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);
                final int verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;

                switch (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) {
                    case Gravity.CENTER_HORIZONTAL:
                        childLeft = parentLeft + (parentRight - parentLeft - width) / 2 +
                        lp.leftMargin - lp.rightMargin;
                        break;
                    case Gravity.RIGHT:
                        if (!forceLeftGravity) {
                            childLeft = parentRight - width - lp.rightMargin;
                            break;
                        }
                    case Gravity.LEFT:
                    default:
                        childLeft = parentLeft + lp.leftMargin;
                }

                switch (verticalGravity) {
                    case Gravity.TOP:
                        childTop = parentTop + lp.topMargin;
                        break;
                    case Gravity.CENTER_VERTICAL:
                        childTop = parentTop + (parentBottom - parentTop - height) / 2 +
                        lp.topMargin - lp.bottomMargin;
                        break;
                    case Gravity.BOTTOM:
                        childTop = parentBottom - height - lp.bottomMargin;
                        break;
                    default:
                        childTop = parentTop + lp.topMargin;
                }

                child.layout(childLeft, childTop, childLeft + width, childTop + height);
            }
        }
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>layoutChildren å‡½æ•°ä¸­ï¼Œé€ä¸ªè®¡ç®—å¥½ å­View çš„å¸ƒå±€ï¼Œåœ¨è°ƒç”¨ child.layout è§¦å‘ å­ View çš„å¸ƒå±€æµç¨‹ã€‚<br /></p>
<ul>
  <li>ç¬¬ä¸‰æ­¥å°èŠ‚
åˆ°è¿™ä¸€æ­¥ç»“æŸåï¼Œåç»­å¸ƒå±€æµç¨‹çš„ æ™®é€š ViewGroupçš„å­ç±» å’Œ æ™®é€š View çš„å­ç±» çš„ layout å’Œ onLayout æµç¨‹çš„å¤§è‡´ç›¸å½“çš„ï¼Œéƒ½æ˜¯è°ƒç”¨ View#layout â€“ setFrame è®¾å®šè‡ªå·±çš„å¸ƒå±€ï¼ŒViewGroupçš„å­ç±»åœ¨ onLayout å‡½æ•°ä¸­è®¡ç®—å¥½ å­View çš„å¸ƒå±€ï¼Œå¹¶è§¦å‘å­ View çš„å¸ƒå±€æµç¨‹ã€‚åœ¨è¿™è¿‡ç¨‹ï¼ŒViewGroupçš„å­ç±»å¯èƒ½ä¼šè°ƒç”¨åˆ°çˆ¶ç±»çš„ä¸€äº›å‡½æ•°ã€‚</li>
</ul>

<h2 id="ç¬¬å››æ­¥æ™®é€šviewgroupçš„å­ç±»layout">ç¬¬å››æ­¥ï¼Œæ™®é€šViewGroupçš„å­ç±»#layout</h2>
<p>æ™®é€šViewGroupçš„å­ç±»ï¼Œè°ƒç”¨ ViewGroup#layou â€“ View#layout ï¼ŒåŒä»£ç æ®µ2.1ã€‚</p>

<h2 id="ç¬¬äº”æ­¥æ™®é€šviewgroupçš„å­ç±»onlayout">ç¬¬äº”æ­¥ï¼Œæ™®é€šViewGroupçš„å­ç±»#onLayout</h2>
<p>ä»¥ LinearLayout ä¸ºä¾‹ï¼Œä»£ç ä»…å‚è€ƒï¼Œä¸åˆ†æã€‚
æºç æ®µ5:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>// LinearLayout ç±»

    @Override
    protected void onLayout(boolean changed, int l, int t, int r, int b) {
        if (mOrientation == VERTICAL) {
            layoutVertical(l, t, r, b);
        } else {
            layoutHorizontal(l, t, r, b);
        }
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td><td class="rouge-code"><pre>// LinearLayout ç±»

    /**
     * Position the children during a layout pass if the orientation of this
     * LinearLayout is set to {@link #VERTICAL}.
     *
     * @see #getOrientation()
     * @see #setOrientation(int)
     * @see #onLayout(boolean, int, int, int, int)
     * @param left
     * @param top
     * @param right
     * @param bottom
     */
    void layoutVertical(int left, int top, int right, int bottom) {
        final int paddingLeft = mPaddingLeft;

        int childTop;
        int childLeft;

        // Where right end of child should go
        final int width = right - left;
        int childRight = width - mPaddingRight;

        // Space available for child
        int childSpace = width - paddingLeft - mPaddingRight;

        final int count = getVirtualChildCount();

        final int majorGravity = mGravity &amp; Gravity.VERTICAL_GRAVITY_MASK;
        final int minorGravity = mGravity &amp; Gravity.RELATIVE_HORIZONTAL_GRAVITY_MASK;

        switch (majorGravity) {
           case Gravity.BOTTOM:
               // mTotalLength contains the padding already
               childTop = mPaddingTop + bottom - top - mTotalLength;
               break;

               // mTotalLength contains the padding already
           case Gravity.CENTER_VERTICAL:
               childTop = mPaddingTop + (bottom - top - mTotalLength) / 2;
               break;

           case Gravity.TOP:
           default:
               childTop = mPaddingTop;
               break;
        }

        for (int i = 0; i &lt; count; i++) {
            final View child = getVirtualChildAt(i);
            if (child == null) {
                childTop += measureNullChild(i);
            } else if (child.getVisibility() != GONE) {
                final int childWidth = child.getMeasuredWidth();
                final int childHeight = child.getMeasuredHeight();

                final LinearLayout.LayoutParams lp =
                        (LinearLayout.LayoutParams) child.getLayoutParams();

                int gravity = lp.gravity;
                if (gravity &lt; 0) {
                    gravity = minorGravity;
                }
                final int layoutDirection = getLayoutDirection();
                final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);
                switch (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) {
                    case Gravity.CENTER_HORIZONTAL:
                        childLeft = paddingLeft + ((childSpace - childWidth) / 2)
                                + lp.leftMargin - lp.rightMargin;
                        break;

                    case Gravity.RIGHT:
                        childLeft = childRight - childWidth - lp.rightMargin;
                        break;

                    case Gravity.LEFT:
                    default:
                        childLeft = paddingLeft + lp.leftMargin;
                        break;
                }

                if (hasDividerBeforeChildAt(i)) {
                    childTop += mDividerHeight;
                }

                childTop += lp.topMargin;
		 //  è®¡ç®—å¥½ child çš„å¸ƒå±€åï¼Œè®¾ç½®ç»™ child
                setChildFrame(child, childLeft, childTop + getLocationOffset(child),
                        childWidth, childHeight);
                childTop += childHeight + lp.bottomMargin + getNextLocationOffset(child);

                i += getChildrenSkipCount(child, i);
            }
        }
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>// LinearLayout ç±»

    private void setChildFrame(View child, int left, int top, int width, int height) {
        child.layout(left, top, left + width, top + height);
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ç¬¬å…­æ­¥æ™®é€šviewçš„å­ç±»-viewlayout">ç¬¬å…­æ­¥ï¼Œæ™®é€šViewçš„å­ç±»-View#layout</h2>
<p>æ™®é€šViewçš„å­ç±»ï¼Œç›´æ¥ä½¿ç”¨çˆ¶ç±» View çš„ layou å‡½æ•°ï¼Œè®¾ç½®äº†è‡ªå·±çš„å¸ƒå±€ï¼Œé€»è¾‘åŒç¬¬å››æ­¥ï¼Œä¹ŸåŒæºç æ®µ2.1ã€‚</p>

<h2 id="ç¬¬ä¸ƒæ­¥æ™®é€šviewçš„å­ç±»onlayout-ä»¥-textview-ä¸ºä¾‹">ç¬¬ä¸ƒæ­¥ï¼Œæ™®é€šViewçš„å­ç±»#onLayout (ä»¥ TextView ä¸ºä¾‹)</h2>
<p>è‡ªå·±çš„å¸ƒå±€ï¼Œåœ¨ layout å‡½æ•°ä¸­å·²ç»è®¾å®šäº†ï¼ŒonLayout å‡½æ•°ä¸»è¦æ˜¯æ‹“å±•ä¸€äº›è‡ªå·±çš„ç‰¹è‰²åŠŸèƒ½çš„ã€‚
æºç æ®µ7:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>// TextView ç±»

    @Override
    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {
        super.onLayout(changed, left, top, right, bottom);
        if (mDeferScroll &gt;= 0) {
            int curs = mDeferScroll;
            mDeferScroll = -1;
            bringPointIntoView(Math.min(curs, mText.length()));
        }
        // Call auto-size after the width and height have been calculated.
        autoSizeText();
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="æœ€åé™„è¡¨æ ¼ä¸€å¼ ">æœ€åé™„è¡¨æ ¼ä¸€å¼ </h5>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Â </th>
      <th style="text-align: left">layout</th>
      <th style="text-align: left">onLayout</th>
      <th style="text-align: left">Â </th>
      <th style="text-align: left">layout</th>
      <th style="text-align: left">onLayout</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ViewGroup</td>
      <td style="text-align: left">super.layoutï¼›é€šçŸ¥è§‚å¯Ÿè€…</td>
      <td style="text-align: left">null</td>
      <td style="text-align: left">View</td>
      <td style="text-align: left">è®°å½•ä½ç½®ï¼Œè°ƒç”¨onLayout</td>
      <td style="text-align: left">null</td>
    </tr>
    <tr>
      <td style="text-align: left">ViewGroupå­ç±»</td>
      <td style="text-align: left">null</td>
      <td style="text-align: left">æ ¹æ®è‡ªèº«å¸ƒå±€çš„ç‰¹ç‚¹æ¥ç¡®å®šå¸ƒå±€ï¼Œforå¾ªç¯ ï¼šè°ƒç”¨ child.layout</td>
      <td style="text-align: left">Viewå­ç±»</td>
      <td style="text-align: left">null</td>
      <td style="text-align: left">super.onLayoutï¼›æ‹“å±•è‡ªå·±çš„åŠŸèƒ½</td>
    </tr>
  </tbody>
</table>
:ET