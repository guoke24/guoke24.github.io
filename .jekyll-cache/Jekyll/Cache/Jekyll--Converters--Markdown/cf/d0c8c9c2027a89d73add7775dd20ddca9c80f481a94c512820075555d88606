I"9<h1 id="handler-çš„æ„é€ å‡½æ•°">Handler çš„æ„é€ å‡½æ•°</h1>
<p>Handler åœ¨è¢«å®ä¾‹åŒ–æ—¶ï¼Œå…¶æ„é€ å‡½æ•°ï¼Œä¼šç»‘å®šå½“å‰çº¿ç¨‹çš„ Looper å®ä¾‹ã€‚<br />
å…¶æºç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>// Handler ç±»

    public Handler() {
        this(null, false);
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>// Handler ç±»

    public Handler(Callback callback, boolean async) {
        if (FIND_POTENTIAL_LEAKS) {
            final Class&lt;? extends Handler&gt; klass = getClass();
            if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;
                    (klass.getModifiers() &amp; Modifier.STATIC) == 0) {
                Log.w(TAG, "The following Handler class should be static or leaks might occur: " +
                    klass.getCanonicalName());
            }
        }

	// 1-1 ç»‘å®šå½“å‰çº¿ç¨‹çš„ Looper å®ä¾‹ï¼Œå¹¶è·å¾—å¼•ç”¨
        mLooper = Looper.myLooper();
        if (mLooper == null) {
            throw new RuntimeException(
                "Can't create handler inside thread " + Thread.currentThread()
                        + " that has not called Looper.prepare()");
        }
        mQueue = mLooper.mQueue;
        mCallback = callback;
        mAsynchronous = async;
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>1-1å¤„ï¼Œè°ƒç”¨äº† Looper.myLooper() æ¥è·å–ä¸€ä¸ª looper å®ä¾‹ã€‚<br />
ç»§ç»­ Looper.myLooper() æºç ï¼š</p>

<h1 id="loopermylooper">Looper.myLooper()</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>// Looper ç±»

public static @Nullable Looper myLooper() {
        return sThreadLocal.get();
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="looper-çš„æˆå‘˜å˜é‡-sthreadlocal">Looper çš„æˆå‘˜å˜é‡ sThreadLocal</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>// Looper ç±»

    // sThreadLocal.get() will return null unless you've called prepare().
    static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ç”±æ­¤å¯çŸ¥ï¼Œé™æ€å‡½æ•° myLooper() å†…æ˜¯å§”æ‰˜é™æ€æˆå‘˜å˜é‡ sThreadLocal çš„ get å‡½æ•°æ¥å– Looper å®ä¾‹çš„ã€‚<br /></p>

<p>sThreadLocal æ˜¯ä¸€ä¸ªé™æ€æˆå‘˜å˜é‡ï¼Œæ„å‘³ç€è¯¥å˜é‡æ˜¯è¿›ç¨‹å”¯ä¸€çš„ã€‚
è¿™æ ·ä½¿å¾—è¿›ç¨‹å†…çš„æ‰€æœ‰çº¿ç¨‹ï¼Œéƒ½ä¼šå§”æ‰˜è¯¥å˜é‡æ¥ç»Ÿä¸€è¿›è¡Œ Looper ç»‘å®šã€‚<br /></p>

<p>sThreadLocal å±äº ThreadLocal ç±»ï¼Œå†çœ‹å…¶ get å‡½æ•°å†…éƒ¨ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>// ThreadLocal ç±»

    public T get() {
        Thread t = Thread.currentThread();
        // 2-1 æ‹¿åˆ° æœ¬åœ°çº¿ç¨‹map
        ThreadLocalMap map = getMap(t); 
        if (map != null) {
            // 2-2 ä»¥è‡ªèº«ä¸º keyï¼Œå–å‡º value
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                @SuppressWarnings("unchecked")
                T result = (T)e.value;// 2-3
                return result;
            }
        }
        return setInitialValue();
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»§ç»­çœ‹ 2-1 å¤„ï¼Œ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>    ThreadLocalMap getMap(Thread t) {
        return t.threadLocals;
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>getMap å‡½æ•°æ‹¿åˆ°çš„ map æ˜¯å½“å‰çº¿ç¨‹ Thread ç±»å®ä¾‹çš„æˆå‘˜å˜é‡ threadLocalsã€‚
é€šè¿‡å˜é‡ map å­˜å–çš„æ•°æ®ï¼Œéƒ½æ˜¯çº¿ç¨‹ç‰¹æœ‰çš„ã€‚</p>

<h1 id="threadlocal-çš„é™æ€å†…éƒ¨ç±»-threadlocalmap">ThreadLocal çš„é™æ€å†…éƒ¨ç±» ThreadLocalMap</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>// Thread ç±»

    /* ThreadLocal values pertaining to this thread. This map is maintained
     * by the ThreadLocal class. */
    ThreadLocal.ThreadLocalMap threadLocals = null;
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å›çœ‹2-1 å¤„ï¼ŒgetMap å‡½æ•°ï¼Œæ‹¿åˆ°çš„å¼•ç”¨æ˜¯å½“å‰çº¿ç¨‹çš„æˆå‘˜å˜é‡ threadLocalsï¼Œä»ç±»å‹åå­—çœ‹å«ä½œã€Œçº¿ç¨‹æœ¬åœ° mapã€ï¼Œå³ ThreadLocal çš„ å†…éƒ¨é™æ€ç±» ThreadLocalMapã€‚ä»åå­—çœ‹ï¼Œè¿™ä¸ªç±»å‹çš„ä½œç”¨å°±æ˜¯å¸®çº¿ç¨‹å­˜å‚¨ä¸€äº›ã€Œæœ¬åœ°æ•°æ®çš„ mapã€ã€‚<br /></p>

<p>å›åˆ° 2-2 å¤„ï¼Œå†çœ‹ ThreadLocalMap çš„ getEntry å‡½æ•°ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>// ThreadLocal.ThreadLocalMap ç±»

        private Entry getEntry(ThreadLocal&lt;?&gt; key) {
            int i = key.threadLocalHashCode &amp; (table.length - 1);
            Entry e = table[i];
            if (e != null &amp;&amp; e.get() == key)
                return e;
            else
                return getEntryAfterMiss(key, i, e);
        }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä» ThreadLocalMap å†…éƒ¨å˜é‡ table ä¸­å–å‡º  Entry ç±»å®ä¾‹ e è¿”å›ï¼Œåœ¨æ³¨é‡Š2-3å¤„ï¼Œå– e.value å¾—åˆ° Looper å®ä¾‹ã€‚è€Œ Entry æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ç±»å‹ï¼šWeakReference&lt; ThreadLocal&lt; ? &gt; &gt;ï¼Œå…¶æ³›å‹ ThreadLocal&lt; ? &gt; ä½œä¸º keyï¼Œå…¶ value å°±æ˜¯ &lt; ? &gt; ä¸­æŒ‡å®šçš„ç±»å‹å®ä¾‹ã€‚å†å›é¡¾è¿™æ®µä»£ç ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>// Looper ç±»

    // sThreadLocal.get() will return null unless you've called prepare().
    static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°æ­¤ï¼Œå¯çŸ¥ï¼Œnew Handler çš„æ—¶å€™ï¼Œä¼šå§”æ‰˜ Looper ç±»çš„é™æ€å‡½æ•° myLooper() ï¼Œå†å§”æ‰˜å…¶çš„é™æ€æˆå‘˜ sThreadLocal çš„ get å‡½æ•°ï¼Œä»å½“å‰çš„çº¿ç¨‹å®ä¾‹çš„æˆå‘˜å˜é‡ threadLocals ä¸­å–å‡º key å€¼ä¸º ThreadLocal&lt; Looper &gt;çš„ value å€¼ï¼Œå³ä¸€ä¸ª Looper å¯¹è±¡ã€‚<br /></p>

<p>å…³ç³»é“¾ï¼š
Thread å¯¹è±¡ â€“ Looper ç±» â€“ sThreadLocal å®ä¾‹ â€“ å½“å‰ Thread å®ä¾‹.threadLocals<br /></p>

<p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„é—®é¢˜ï¼Œä»€ä¹ˆæ—¶å€™å¾€å½“å‰ Thread å®ä¾‹çš„æˆå‘˜å˜é‡ threadLocals ä¸­æ”¾å…¥ä¸€ä¸ª Looper å®ä¾‹å‘¢ï¼Ÿ<br /></p>

<p>é‚£å°±æ˜¯åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œ Looper.prepare() çš„æ—¶å€™ã€‚</p>

<h1 id="looperprepare">Looper.prepare()</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>// Looper ç±»

    /** Initialize the current thread as a looper.
      * This gives you a chance to create handlers that then reference
      * this looper, before actually starting the loop. Be sure to call
      * {@link #loop()} after calling this method, and end it by calling
      * {@link #quit()}.
      */
    public static void prepare() {
        prepare(true);
    }

    private static void prepare(boolean quitAllowed) {
        if (sThreadLocal.get() != null) {
            throw new RuntimeException("Only one Looper may be created per thread");
        }
        sThreadLocal.set(new Looper(quitAllowed)); //3-1
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>set å‰æœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œä½¿å¾—åªèƒ½æ”¾å…¥ä¸€ä¸ª Looper å®ä¾‹åˆ°å½“å‰çº¿ç¨‹ã€‚</p>

<p>æ¥ç€ 3-1 ï¼Œ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>// ThreadLocal ç±»

    public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null)
            map.set(this, value); // 4-1
        else
            createMap(t, value); // 4-2
    }


//  ã€‚ã€‚ã€‚

    void createMap(Thread t, T firstValue) {
        t.threadLocals = new ThreadLocalMap(this, firstValue);
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ ThreadLocal çš„ set å‡½æ•°å†…ï¼Œå…ˆæ‹¿åˆ°å½“å‰çš„çº¿ç¨‹å®ä¾‹çš„æˆå‘˜å˜é‡ threadLocals ï¼Œè‹¥ä¸ºç©ºå°±å»åˆ›å»ºä¸€ä¸ªã€‚
å…¶ ThreadLocalMap ç±»çš„æ„é€ å‡½æ•°ä¸ºï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>// ThreadLocal.ThreadLocalMap ç±»

        ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {
            table = new Entry[INITIAL_CAPACITY];
            int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);
            table[i] = new Entry(firstKey, firstValue);
            size = 1;
            setThreshold(INITIAL_CAPACITY);
        }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åˆ›å»ºçš„åŒæ—¶å°±æ”¾ä¸€ä¸ª Object ç±»å‹çš„  firstValue  åˆ° table æ•°ç»„å˜é‡ã€‚
åœ¨ Looper è¿™é‡Œï¼Œæ”¾å…¥çš„é”®å€¼å¯¹å°±æ˜¯ ThreadLocal<Looper> -- new Looper() ã€‚</Looper></p>

<p>å†çœ‹ 4-1ï¼Œ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre>// ThreadLocal.ThreadLocalMap ç±»

        private void set(ThreadLocal&lt;?&gt; key, Object value) {

            // We don't use a fast path as with get() because it is at
            // least as common to use set() to create new entries as
            // it is to replace existing ones, in which case, a fast
            // path would fail more often than not.

            Entry[] tab = table;
            int len = tab.length;
            int i = key.threadLocalHashCode &amp; (len-1);

            for (Entry e = tab[i];
                 e != null;
                 e = tab[i = nextIndex(i, len)]) {
                ThreadLocal&lt;?&gt; k = e.get();

                if (k == key) {
                    e.value = value;
                    return;
                }

                if (k == null) {
                    replaceStaleEntry(key, value, i);
                    return;
                }
            }

            tab[i] = new Entry(key, value);
            int sz = ++size;
            if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)
                rehash();
        }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æœ€ç»ˆï¼ŒThreadLocal<Looper> -- new Looper()  è¿™ä¸ªé”®å€¼å¯¹ï¼Œè¢«ä¿å­˜åœ¨ ThreadLocal.ThreadLocalMap ç±»å®ä¾‹çš„ table æ•°ç»„å˜é‡ä¸­ã€‚</Looper></p>

<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>åˆ°æ­¤å¯çŸ¥ï¼Œå·²ç»å¯ä»¥å›ç­”æ–‡ç« æ ‡é¢˜çš„é—®é¢˜äº†ï¼ŒHandler å¦‚ä½•ç»‘å®š Thread çº¿ç¨‹ï¼Ÿ<br />
å½“å‰çº¿ç¨‹åœ¨ new Handler ä¹‹å‰ï¼Œå…ˆå§”æ‰˜äº† Looper çš„é™æ€å‡½æ•° prapare()ï¼Œnew äº†ä¸€ä¸ª Looper å®ä¾‹ï¼Œå†å§”æ‰˜å…¶ é™æ€æˆå‘˜å˜é‡ sThreadLocal çš„ set å‡½æ•°ï¼ŒæŠŠåˆš new çš„ Looper å®ä¾‹åšä¿å­˜æ“ä½œï¼Œå¹¶ä¸”åœ¨ä¿å­˜ä¹‹å‰ï¼Œå…ˆé€šè¿‡ sThreadLocal çš„ get å‡½æ•°ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»ä¿å­˜æœ‰ Looper å®ä¾‹ï¼Œå¦‚æœæœ‰å°±æŠ¥é”™ã€‚è¿™æ ·å°±èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹åªä¿å­˜ä¸€ä¸ª Looper å®ä¾‹ã€‚<br /></p>

<p>è¿™æ ·çš„æœºåˆ¶ï¼Œä½¿å¾—åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼Œæ— è®º new å¤šå°‘ä¸ª Handlerï¼Œé€šè¿‡ Looper ç±»çš„é™æ€å‡½æ•° myLooper() æ‹¿åˆ°çš„ Looper å®ä¾‹éƒ½æ˜¯åŒä¸€ä¸ªã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å†…çš„ Handlerï¼Œé»˜è®¤éƒ½æ˜¯ç»‘å®šå½“å‰çº¿ç¨‹çš„ï¼Œä¸”ç»‘å®šåŒä¸€ä¸ª Looper å®ä¾‹ã€‚<br /></p>

<p>å…³ç³»é“¾ï¼š
Thread å®ä¾‹ â€“ Looper ç±» â€“ Looper ç±».sThreadLocal â€“ Thread å®ä¾‹.threadLocals <br /></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Thread å®ä¾‹</th>
      <th style="text-align: left">Looper ç±»</th>
      <th style="text-align: left">sThreadLocal å®ä¾‹ï¼ˆThreadLocal ç±»ï¼‰</th>
      <th style="text-align: left">Thread å®ä¾‹.threadLocalsï¼ˆThreadLocal. ThreadLocalMap ç±»ï¼‰</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">è°ƒç”¨ Looper#prepare å‡½æ•°</td>
      <td style="text-align: left">sThreadLocal.get() åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å·²æœ‰Looperï¼›new ä¸€ä¸ª Looperå®ä¾‹ï¼Œå§”æ‰˜ sThreadLocal.set å‡½æ•°è¿›è¡Œä¿å­˜</td>
      <td style="text-align: left">é€šè¿‡è¯¥è°ƒç”¨ Thread.currentThread()ï¼Œä½¿å¾—åç»­æ“ä½œéƒ½æ˜¯åŸºäºå½“å‰çº¿ç¨‹ï¼›å–å¾—å½“å‰æœ¬åœ°çº¿ç¨‹mapï¼Œé€šè¿‡å…¶ set å’Œ getEntry å‡½æ•°æ¥å­˜å– Looper å®ä¾‹</td>
      <td style="text-align: left">å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª table æ•°ç»„ï¼Œå…¶å…ƒç´ æ˜¯å¼±å¼•ç”¨ç±»å‹çš„å­ç±» Entryï¼Œä»¥ ThreadLocal&lt;?&gt; ä¸º key å€¼ï¼ŒObject ç±»å‹ä¸º valueå€¼ï¼›æä¾› set å’Œ getEntry å‡½æ•°ç»™å¤–éƒ¨è¿›è¡Œå­˜å–æ“ä½œ</td>
    </tr>
    <tr>
      <td style="text-align: left">Â </td>
      <td style="text-align: left">Â </td>
      <td style="text-align: left">Â </td>
      <td style="text-align: left">Â </td>
    </tr>
  </tbody>
</table>

<h1 id="å»¶ä¼¸">å»¶ä¼¸</h1>
<p>æ›´è¯¦ç»†çš„å†…å®¹ï¼Œå¯ä»¥å‚è€ƒæ–‡ç«  [[ ThreadLocal åŸç† ]] ã€‚<br /></p>

<p>Looper.prepare()  å‡½æ•°ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œå·²ç»åœ¨ ActivityThread çš„ main å‡½æ•°å†…æ‰§è¡Œè¿‡ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸éœ€è¦å¼€å‘è€…æ‰‹åŠ¨è°ƒç”¨ï¼Œä½†å¦‚æœåœ¨å­çº¿ç¨‹ä¸­ new Handlerï¼Œå°±éœ€è¦å…ˆæ‰§è¡Œä¸€æ¬¡ Looper.prepare()  å‡½æ•°ã€‚</p>

:ET