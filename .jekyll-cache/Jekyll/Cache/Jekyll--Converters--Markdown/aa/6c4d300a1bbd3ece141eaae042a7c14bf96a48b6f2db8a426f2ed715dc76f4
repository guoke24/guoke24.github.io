I"‰Ö<h1 id="å‰è¨€">å‰è¨€</h1>

<p>ä¹‹æ‰€ä»¥ä¼šç ”ç©¶è¿™å—å†…å®¹ï¼Œæ˜¯å› ä¸ºå‰æ®µæ—¶é—´æ¥æ‰‹çš„ä¸€ä¸ªéªŒç­¾çš„é¡¹ç›®ï¼Œæ­£æ˜¯éµå¾ªäº† Android V2 ç­¾åæ–¹æ¡ˆï¼Œäºæ˜¯å°±å»ç ”ç©¶äº†ä¸€éƒ¨åˆ† Android åŸç”Ÿçš„ V2 åŠ ç­¾å’ŒéªŒç­¾çš„æºç ï¼Œç°åœ¨è¶ç€æ¯”è¾ƒç©ºé—²ï¼Œå°±æŠŠ Android åŸç”Ÿçš„ V2 åŠ ç­¾å’ŒéªŒç­¾çš„æºç æ¢³ç†ä¸€ç•ªã€‚æœ¬ç¯‡æ–‡ç« å°†ç ”ç©¶ <strong>åŠ ç­¾</strong> è¿™ä¸€å—çš„æºç ã€‚</p>

<h1 id="v2-ç­¾åæ–¹æ¡ˆçš„åŸç†">V2 ç­¾åæ–¹æ¡ˆçš„åŸç†</h1>

<p>é¦–å…ˆï¼Œæ‰¾åˆ°è°·æ­Œå®˜æ–¹çš„æ–‡æ¡£ï¼Œéœ€è¦ç¿»å¢™ï¼š<br />
<a href="https://source.android.com/security/apksigning/v2">APK ç­¾åæ–¹æ¡ˆ v2</a><br />
è¾…åŠ©ç†è§£ï¼š<br />
<a href="https://www.jianshu.com/p/dc320629bf9d">Android V2ç­¾åæœºåˆ¶ä»¥åŠApkSignerV2ç­¾åæºç è§£æ</a><br />
<a href="https://blog.csdn.net/freekiteyu/article/details/84849651">ä¸€ç¯‡æ–‡ç« çœ‹æ˜ç™½ Android v1 &amp; v2 ç­¾åæœºåˆ¶</a><br /></p>

<p>v2 ç­¾åçš„æ•´ä½“æµç¨‹æ¦‚æ‹¬ï¼š<br />
ä¸€ä¸ª APK æ–‡ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ª ZIP æ ¼å¼çš„æ–‡ä»¶ï¼Œè€Œä¸€ä¸ª ZIP æ ¼å¼çš„æ–‡ä»¶åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š<br />
<strong>å†…å®¹å»ï¼Œä¸­å¤®ç›®å½•åŒºï¼Œç»“å°¾åŒº</strong>ã€‚<br />
<strong>ç»“å°¾åŒº</strong> å†…è®°å½•äº† <strong>ä¸­å¤®ç›®å½•åŒº</strong> åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ã€‚<br />
æ‰€è°“çš„ V2 ç­¾åæ–¹æ¡ˆï¼Œå°±æ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼Œäº§ç”Ÿç­¾åå—ï¼Œå†æŠŠç­¾åå—æ’å…¥åˆ° <strong>å†…å®¹åŒºå’Œä¸­å¤®ç›®å½•åŒº</strong> ä¹‹é—´ï¼Œ<br />
ç„¶åå†æ›´æ–° <strong>ç»“å°¾åŒº</strong> å†…çš„ä¸­å¤®ç›®å½•åŒºçš„åç§»é‡çš„å€¼ã€‚<br /></p>

<p>å€Ÿç”¨å®˜æ–¹çš„å›¾ï¼Œå¦‚ä¸‹ï¼š<br />
<img src="http://guoke24.top/img/apk-before-after-signing.png" alt="" /><br /></p>

<p>å¦‚å›¾æ‰€ç¤ºï¼Œçº¢è‰²é‚£ä¸€å—ä»£è¡¨äº† APK ç­¾åå—ã€‚<br />
ç”¨ç±»jsonæ ¼å¼è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>apk
{
    beforeCentralDir,
    apkSigningBlock,// apk ç­¾ååˆ†å—
    centralDir,
    eocd,
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ä¸‹æ¥è¯´ä¸€ä¸‹ <strong>ç­¾åå—</strong> çš„å†…éƒ¨ç»“æ„ã€‚<br />
å¼•ç”¨å®˜æ–¹æ–‡æ¡£ä¸­æè¿° <strong>ç­¾åå—</strong> ç»“æ„çš„ä¸€æ®µè¯ï¼š</p>
<blockquote>
  <p>æ ¼å¼<br />
â€œAPK ç­¾ååˆ†å—â€çš„æ ¼å¼å¦‚ä¸‹ï¼ˆæ‰€æœ‰æ•°å­—å­—æ®µå‡é‡‡ç”¨å°ç«¯å­—èŠ‚åºï¼‰ï¼š</p>
  <ul>
    <li>size of blockï¼Œä»¥å­—èŠ‚æ•°ï¼ˆä¸å«æ­¤å­—æ®µï¼‰è®¡ (uint64)</li>
    <li>å¸¦ uint64 é•¿åº¦å‰ç¼€çš„â€œID-å€¼â€å¯¹åºåˆ—ï¼š
      <ul>
        <li>ID (uint32)</li>
        <li>valueï¼ˆå¯å˜é•¿åº¦ï¼šâ€œID-å€¼â€å¯¹çš„é•¿åº¦ - 4 ä¸ªå­—èŠ‚ï¼‰</li>
      </ul>
    </li>
    <li>size of blockï¼Œä»¥å­—èŠ‚æ•°è®¡ - ä¸ç¬¬ä¸€ä¸ªå­—æ®µç›¸åŒ (uint64)</li>
    <li>magicâ€œAPK ç­¾ååˆ†å— 42â€ï¼ˆ16 ä¸ªå­—èŠ‚ï¼‰</li>
  </ul>
</blockquote>

<p>ç”¨ç±»jsonæ ¼å¼è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>apk
{
    beforeCentralDir,
    apkSigningBlock,// apk ç­¾ååˆ†å—
		{
		    blockSizeFieldValue,
		    pairSizeFieldValue,
		    APK_SIGNATURE_SCHEME_V2_BLOCK_ID,
		    apkSignatureSchemeV2Blockï¼Œ// value å€¼ï¼Œå†…å« â€œID-å€¼â€å¯¹ï¼ŒV2 åˆ†å—
		    blockSizeFieldValue,
		    APK_SIGNING_BLOCK_MAGIC,
		}
    centralDir,
    eocd,
}
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ¥ä¸‹æ¥è¯´ä¸€ä¸‹ <strong>ç­¾åå— V2 åˆ†å—</strong> çš„å†…éƒ¨ç»“æ„ã€‚<br />
å¼•ç”¨å®˜æ–¹æ–‡æ¡£ä¸­æè¿° <strong>ç­¾åå— V2 åˆ†å—</strong> ç»“æ„çš„ä¸€æ®µè¯ï¼š</p>
<blockquote>
  <p>æ ¼å¼<br />
â€œAPK ç­¾åæ–¹æ¡ˆ v2 åˆ†å—â€å­˜å‚¨åœ¨â€œAPK ç­¾ååˆ†å—â€å†…ï¼ŒID ä¸º 0x7109871aã€‚<br />
â€œAPK ç­¾åæ–¹æ¡ˆ v2 åˆ†å—â€çš„æ ¼å¼å¦‚ä¸‹ï¼ˆæ‰€æœ‰æ•°å­—å€¼å‡é‡‡ç”¨å°ç«¯å­—èŠ‚åºï¼Œæ‰€æœ‰å¸¦é•¿åº¦å‰ç¼€çš„å­—æ®µå‡ä½¿ç”¨ uint32 å€¼è¡¨ç¤ºé•¿åº¦ï¼‰ï¼š<br /></p>
  <ul>
    <li>å¸¦é•¿åº¦å‰ç¼€çš„ signerï¼ˆå¸¦é•¿åº¦å‰ç¼€ï¼‰åºåˆ—ï¼š<br />
      <ul>
        <li>å¸¦é•¿åº¦å‰ç¼€çš„ signed dataï¼š<br />
          <ul>
            <li>å¸¦é•¿åº¦å‰ç¼€çš„ digestsï¼ˆå¸¦é•¿åº¦å‰ç¼€ï¼‰åºåˆ—ï¼š<br />
              <ul>
                <li>signature algorithm ID (uint32)<br /></li>
                <li>ï¼ˆå¸¦é•¿åº¦å‰ç¼€ï¼‰digest - è¯·å‚é˜…å—å®Œæ•´æ€§ä¿æŠ¤çš„å†…å®¹<br /></li>
              </ul>
            </li>
            <li>å¸¦é•¿åº¦å‰ç¼€çš„ X.509 certificates åºåˆ—ï¼š<br />
              <ul>
                <li>å¸¦é•¿åº¦å‰ç¼€çš„ X.509 certificateï¼ˆASN.1 DER å½¢å¼ï¼‰<br /></li>
              </ul>
            </li>
            <li>å¸¦é•¿åº¦å‰ç¼€çš„ additional attributesï¼ˆå¸¦é•¿åº¦å‰ç¼€ï¼‰åºåˆ—ï¼š<br />
              <ul>
                <li>ID (uint32)<br /></li>
                <li>valueï¼ˆå¯å˜é•¿åº¦ï¼šé™„åŠ å±æ€§çš„é•¿åº¦ - 4 ä¸ªå­—èŠ‚ï¼‰<br /></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>å¸¦é•¿åº¦å‰ç¼€çš„ signaturesï¼ˆå¸¦é•¿åº¦å‰ç¼€ï¼‰åºåˆ—ï¼š<br />
          <ul>
            <li>signature algorithm ID (uint32)<br /></li>
            <li>signed data ä¸Šå¸¦é•¿åº¦å‰ç¼€çš„ signature<br /></li>
          </ul>
        </li>
        <li>å¸¦é•¿åº¦å‰ç¼€çš„ public keyï¼ˆSubjectPublicKeyInfoï¼ŒASN.1 DER å½¢å¼ï¼‰<br /></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><strong>ç­¾åå— v2 åˆ†å—</strong> ç”¨ç±»jsonæ ¼å¼è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>apkSignatureSchemeV2Blockï¼Œ// value å€¼ï¼Œå†…å« â€œID-å€¼â€å¯¹ï¼ŒV2 åˆ†å—  
{
	len-signers[len-signer]
	{
		signer
		{
			len-signedData, //ç­¾åæ•°æ®
			{
				len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],  
				len-certificates["len-certificate"], //ä»ç¬¬ä¸€ä¸ª certificate å†…çš„å…¬é’¥ï¼Œå¯¹åº”ç­¾åçš„ç§é’¥
				len-additional_attributes["len-(ID-(len-attribute))"],  
			}
			len-signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"], //ç­¾åå€¼ 
			len-publicKey // å…¬é’¥ï¼Œç¬¬ä¸€ä¸ª certificate å†…å–åˆ°çš„ 
		}
}
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å…¶ä¸­ï¼Œâ€œlen-â€è¡¨ç¤ºå¸¦é•¿åº¦å‰ç¼€çš„æ„æ€ï¼Œâ€œsigners[signer]â€è¡¨ç¤ºï¼š signer åºåˆ—ï¼Œæ‰€ä»¥ï¼Œç»“åˆèµ·æ¥ï¼š<br />
â€œlen-signers[signer]â€è¡¨ç¤ºï¼šå¸¦é•¿åº¦å‰ç¼€çš„ signer åºåˆ—ï¼›<br />
â€œlen-signers[len-signer]â€è¡¨ç¤ºï¼šå¸¦é•¿åº¦å‰ç¼€çš„ signerï¼ˆå¸¦é•¿åº¦å‰ç¼€ï¼‰åºåˆ—ï¼›<br />
æ¢å¥è¯è¯´ï¼Œsigners[signer] å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆä¹Ÿç§°åºåˆ—ï¼‰ï¼Œå†…éƒ¨å…ƒç´ ä¸º signerï¼Œæ¥ç€ç»™æ¯ä¸ªå†…éƒ¨å…ƒç´ åŠ ä¸Šé•¿åº¦å‰ç¼€ï¼Œå°±æœ‰ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼š<br />
signers[len-signer]ï¼Œå†…éƒ¨å…ƒç´ ä¸º len-signerï¼Œå¦‚æœå†ç»™è¯¥æ–°çš„æ•°ç»„åŠ ä¸€ä¸ªé•¿åº¦å‰ç¼€ï¼Œå°±æœ‰ï¼š<br />
len-signers[len-signer]ã€‚<br />
<strong>ç­¾åå— v2 åˆ†å—</strong>,æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª <strong>å¸¦é•¿åº¦å‰ç¼€çš„åºåˆ—ï¼ˆæ•°ç»„ï¼‰</strong>ï¼Œ<br />
å…¶å†…éƒ¨æ¯ä¸ªå…ƒç´ ä¸º <strong>å¸¦é•¿åº¦å‰ç¼€çš„ signer</strong>ï¼Œå³å…¶å†…éƒ¨æ¯ä¸ªå…ƒç´ ä¸º <strong>len-signer</strong>ã€‚<br />
<br />
<strong>è¡¥å……è¯´æ˜ï¼šåœ¨ä¸Šè¿°çš„ç±»jsonæ ¼å¼çš„ä»£ç ä¸­ï¼Œâ€œ[]â€è¡¨ç¤ºä¸€ä¸ªåºåˆ—ï¼ˆæ•°ç»„ï¼‰ï¼Œå†…å«nä¸ªåŒç±»å‹å…ƒç´ ,â€œ{}â€è¡¨ç¤ºä¸€ä¸ªç»“æ„ä½“ï¼Œå†…éƒ¨çš„å…ƒç´ éƒ½åªæœ‰ä¸€ä¸ªã€‚</strong><br />
<br /></p>
<ul>
  <li>signer çš„å†…éƒ¨ç»“æ„ï¼ŒåŒ…å«ä¸ªä¸‰å…ƒç´ ï¼šlen-signedDataï¼Œlen-signaturesï¼Œlen-publicKeyï¼›<br />
    <ul>
      <li>ç¬¬ä¸€ä¸ªå…ƒç´  len-signedData ï¼Œç­¾åæ•°æ®ï¼Œå…¶å†…éƒ¨ç»“æ„æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æ…¢æ…¢å°†ä¹‹æ‹†åˆ†ï¼š
        <ul>
          <li>signedData å†…éƒ¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå®ƒçš„æ ¼å¼ä¸º len-digestsï¼Œå³å¸¦é•¿åº¦å‰ç¼€çš„æ‘˜è¦åºåˆ—ï¼ˆæ•°ç»„ï¼‰ï¼Œ<br />
å…¶å†…éƒ¨å«å¤šä¸ªç›¸åŒæ ¼å¼çš„å…ƒç´  [â€œlen-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))â€]ï¼Œå³å¸¦é•¿åº¦å‰ç¼€çš„â€œID-valueâ€å¯¹ï¼Œ<br />
å…¶ ID æ˜¯ ç­¾åç®—æ³•IDï¼Œvalue æ˜¯ len-æ‘˜è¦ï¼Œå³å¸¦é•¿åº¦å‰ç¼€çš„æ‘˜è¦ï¼Œ<br />
åˆ°è¿™æˆ‘ä»¬å°±å¯ä»¥ç®€å•ç†è§£ä¸ºï¼Œdigests æ¯ä¸ªå†…éƒ¨å…ƒç´ å°±æ˜¯ä¸€ä¸ª â€œç®—æ³•ID-æ‘˜è¦â€ çš„æ˜ å°„å¯¹ï¼›<br />
ä¸ºä½•æ˜¯è¿™ç§ç»“æ„ï¼Œåç»­æºç åˆ†æçš„æ—¶å€™ä¼šè®²åˆ°ã€‚è€Œæ­¤å¤„çš„æ‘˜è¦ï¼Œæ˜¯æœªç­¾åçš„ APK åœ¨å¯¹åº”çš„ç®—æ³•ä¸‹ï¼Œè®¡ç®—å‡ºæ¥çš„æ‘˜è¦å€¼ã€‚</li>
          <li>signedData å†…éƒ¨çš„ç¬¬äºŒä¸ªå…ƒç´ ï¼Œå®ƒçš„æ ¼å¼ä¸º len-certificatesï¼Œå¸¦é•¿åº¦å‰ç¼€çš„è¯ä¹¦åºåˆ—ï¼ˆæ•°ç»„ï¼‰ï¼Œ<br />
å…¶å†…éƒ¨å«å¤šä¸ªç›¸åŒæ ¼å¼çš„å…ƒç´  [â€œlen-certificateâ€]ï¼Œå³å¸¦é•¿åº¦å‰ç¼€çš„è¯ä¹¦ï¼›</li>
          <li>signedData å†…éƒ¨çš„ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼Œå®ƒçš„æ ¼å¼ä¸º len-additional_attributesï¼Œå³å¸¦é•¿åº¦å‰ç¼€çš„é™„åŠ æ•°æ®åºåˆ—ï¼ˆæ•°ç»„ï¼‰ï¼Œ<br />
å…¶å†…éƒ¨å…ƒç´ çš„ç»“æ„è·Ÿ signedData å†…éƒ¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ç±»ä¼¼ã€‚è€Œä¸” Android åŸç”Ÿçš„ V2 ç­¾åä¸å¸¦æ•°é™„åŠ æ®ï¼Œåç»­æºç ä¼šè®²åˆ°ã€‚</li>
        </ul>
      </li>
      <li>ç¬¬äºŒä¸ªå…ƒç´  len-signaturesï¼Œç­¾åå€¼åºåˆ—ï¼Œç»“æ„å’Œ len-digests[â€œlen-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))â€] ç±»ä¼¼ï¼Œä¸º[â€œlen-(ç­¾åç®—æ³•ID-(len-signature))â€]ï¼Œæ­¤å¤„çš„ signatureï¼Œæ˜¯åœ¨å¯¹åº”ç®—æ³•ä¸‹ï¼Œå¯¹ä¸å¸¦å‰ç¼€çš„ signedData ç­¾åå¾—åˆ°çš„ã€‚</li>
      <li>ç¬¬ä¸‰ä¸ªå…ƒç´  len-publicKeyï¼Œå¸¦é•¿åº¦å‰ç¼€çš„å…¬é’¥ï¼Œç®€å•ç»“æ„ã€‚</li>
    </ul>
  </li>
</ul>

<p>å†æ¥ä¸€å¼ è¡¨æ ¼å›¾ç¤ºï¼š<br />
<img src="http://guoke24.top/img/v2ç­¾åå—è¡¨æ ¼å›¾ç¤º.png" alt="" /><br /></p>

<p>æœ€ç»ˆï¼ŒAPK çš„æ€»ä½“ç»“æ„å¯ä»¥è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>apk
{
    beforeCentralDir,
    apkSigningBlock,// apk ç­¾ååˆ†å—
	{
		blockSizeFieldValue,
		pairSizeFieldValue,
		APK_SIGNATURE_SCHEME_V2_BLOCK_ID,
		apkSignatureSchemeV2Blockï¼Œ// value å€¼ï¼Œå†…å« â€œID-å€¼â€å¯¹ï¼ŒV2 åˆ†å—
		{
			len-signers[len-signer]
			{
				signer
				{
					len-signedData,
					{
						len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],
						len-certificates["len-certificate"],
						len-new byte[0],
					}
					len-signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"],
					len-publicKey
				}
			}
		}
		blockSizeFieldValue,
		APK_SIGNING_BLOCK_MAGIC,
	}
    centralDir,
    eocd,
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°æ­¤ï¼Œå¯ä»¥ç®€å•çš„è¯´ï¼ŒV2 åˆ†å—å†…ï¼Œæœ‰å¤šä¸ª singerï¼Œè€Œæ¯ä¸ª signer å†…åˆæœ‰å¤šä¸ªæ‘˜è¦ï¼Œå¤šä¸ªè¯ä¹¦å’Œå¤šä¸ªç­¾åå€¼ã€‚<br />
ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„ç»“æ„å‘¢ï¼Ÿé‚£å°±å¾—çœ‹æºç æ‰èƒ½æ‰¾åˆ°ç­”æ¡ˆäº†ã€‚<br /></p>

<h1 id="v2-åŠ ç­¾çš„æºç å®ç°">V2 åŠ ç­¾çš„æºç å®ç°</h1>

<p>æºç åœ¨æ­¤é“¾æ¥å¯ä»¥çœ‹åˆ°ï¼š<a href="https://android.googlesource.com/platform/build/+/dd910c5/tools/signapk/src/com/android/signapk/ApkSignerV2.java">V2åŠ ç­¾æºç </a><br /></p>

<p>èµ·å§‹å‡½æ•°ä¸º sign ï¼›ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<h3 id="ä»£ç æ®µ1">ä»£ç æ®µ1:</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre>    /**
     * Signs the provided APK using APK Signature Scheme v2 and returns the signed APK as a list of
     * consecutive chunks.
     *
     * ......
     *
     * @param inputApk contents of the APK to be signed. The APK starts at the current position
     *        of the buffer and ends at the limit of the buffer.
     * @param signerConfigs signer configurations, one for each signer.
     *
     * ......
     */
    public static ByteBuffer[] sign(
            ByteBuffer inputApk,
            List&lt;SignerConfig&gt; signerConfigs)
            throws ApkParseException, InvalidKeyException, SignatureException {

        ......

        // 1-1
        // Create ByteBuffers holding the contents of everything before ZIP Central Directory,
        // ZIP Central Directory, and ZIP End of Central Directory.
        inputApk.clear();
        ByteBuffer beforeCentralDir = getByteBuffer(inputApk, centralDirOffset);
        ByteBuffer centralDir = getByteBuffer(inputApk, eocdOffset - centralDirOffset);
        // Create a copy of End of Central Directory because we'll need modify its contents later.
        byte[] eocdBytes = new byte[inputApk.remaining()];
        inputApk.get(eocdBytes);
        ByteBuffer eocd = ByteBuffer.wrap(eocdBytes);
        eocd.order(inputApk.order());

        // 1-2
        // Figure which which digests to use for APK contents.
        Set&lt;Integer&gt; contentDigestAlgorithms = new HashSet&lt;&gt;();
        for (SignerConfig signerConfig : signerConfigs) {
            for (int signatureAlgorithm : signerConfig.signatureAlgorithms) {
                contentDigestAlgorithms.add(
                        getSignatureAlgorithmContentDigestAlgorithm(signatureAlgorithm));
            }
        }

        // 1-3
        // Compute digests of APK contents.
        Map&lt;Integer, byte[]&gt; contentDigests; // digest algorithm ID -&gt; digest
        try {
            contentDigests =
                    computeContentDigests(
                            contentDigestAlgorithms,
                            new ByteBuffer[] {beforeCentralDir, centralDir, eocd});
        } catch (DigestException e) {
            throw new SignatureException("Failed to compute digests of APK", e);
        }

        // 1-4
        // Sign the digests and wrap the signatures and signer info into an APK Signing Block.
        ByteBuffer apkSigningBlock =
                ByteBuffer.wrap(generateApkSigningBlock(signerConfigs, contentDigests));

		......

		// 1-5
        // Insert APK Signing Block immediately before the ZIP Central Directory.
        return new ByteBuffer[] {
                beforeCentralDir,
                apkSigningBlock,
                centralDir,
                eocd,
        };
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é¦–å…ˆçœ‹è¯¥å‡½æ•°çš„å…¥å‚ï¼š<br />
<code class="highlighter-rouge">ByteBuffer inputApk</code> å°±æ˜¯å¾…ç­¾åapkçš„å­—èŠ‚æ•°ç»„ï¼Œè¢«åŒ…è£…æˆäº† ByteBufferï¼Œç›®çš„æ˜¯ä¾¿äºè¿›è¡Œè¯»å–å’Œå¤åˆ¶ç­‰æ“ä½œï¼›<br />
<code class="highlighter-rouge">List&lt;SignerConfig&gt; signerConfigs</code> å°±æ˜¯ç­¾åè€…é…ç½®ä¿¡æ¯é›†ï¼Œè¿™æ„å‘³ç€ç­¾åè€…å¯èƒ½ä¸æ­¢ä¸€ä¸ªã€‚<br />
æ¥ç€çœ‹ SignerConfig ç±»çš„æºç ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>    /**
     * Signer configuration.
     */
    public static final class SignerConfig {
        /** Private key. */
        public PrivateKey privateKey;
        /**
         * Certificates, with the first certificate containing the public key corresponding to
         * {@link #privateKey}.
         */
        public List&lt;X509Certificate&gt; certificates;
        /**
         * List of signature algorithms with which to sign (see {@code SIGNATURE_...} constants).
         */
        public List&lt;Integer&gt; signatureAlgorithms;
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å¯çŸ¥ï¼Œæ¯ä¸ª <strong>ç­¾åè€…é…ç½®ä¿¡æ¯</strong> åŒ…æ‹¬ï¼šç§é’¥ï¼Œè¯ä¹¦åºåˆ—ï¼Œç­¾åç®—æ³•IDçš„åºåˆ—ã€‚<br /></p>

<p>æ¥ç€çœ‹ï¼Œ<br />
æ³¨é‡Š1-1å¤„ï¼Œä»å…¥å‚çš„ inputApk æå–å‡ºäº†ä¸‰éƒ¨åˆ†ï¼šbeforeCentralDirã€centralDirã€eocdï¼Œéƒ½æ˜¯ ByteBuffer ç±»å‹ã€‚</p>

<p>æ³¨é‡Š1-2å¤„ï¼Œé€šè¿‡ä¸¤æ¬¡éå†ï¼ŒæŠŠå…¥å‚çš„ signerConfigs çš„æ‰€æœ‰çš„ç­¾åç®—æ³•ï¼Œé€šè¿‡å‡½æ•° getSignatureAlgorithmContentDigestAlgorithm è½¬æ¢æˆå¯¹åº”çš„æ‘˜è¦ç®—æ³•ï¼Œæ·»åŠ åˆ°é›†åˆ contentDigestAlgorithms å»äº†ã€‚<br />
å‡½æ•° getSignatureAlgorithmContentDigestAlgorithm çš„æºç å¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>    private static int getSignatureAlgorithmContentDigestAlgorithm(int sigAlgorithm) {
        switch (sigAlgorithm) {
            case SIGNATURE_RSA_PSS_WITH_SHA256:
            case SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256:
            case SIGNATURE_ECDSA_WITH_SHA256:
            case SIGNATURE_DSA_WITH_SHA256:
                return CONTENT_DIGEST_CHUNKED_SHA256;
            case SIGNATURE_RSA_PSS_WITH_SHA512:
            case SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512:
            case SIGNATURE_ECDSA_WITH_SHA512:
            case SIGNATURE_DSA_WITH_SHA512:
                return CONTENT_DIGEST_CHUNKED_SHA512;
            default:
                throw new IllegalArgumentException(
                        "Unknown signature algorithm: 0x"
                                + Long.toHexString(sigAlgorithm &amp; 0xffffffff));
        }
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ç”±æ­¤å¯çŸ¥ï¼Œç­¾åç®—æ³•æœ‰8ç§ï¼Œæ‘˜è¦ç®—æ³•åªæœ‰ä¸¤ç§ï¼šSHA256 å’Œ SHA512ã€‚</p>

<p>æ³¨é‡Š1-3ï¼Œè®¡ç®—å¹¶æ„é€  â€œæ‘˜è¦ç®—æ³•ID - åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦â€ çš„ æ˜ å°„å¯¹ï¼Œå­˜å‚¨åˆ°å˜é‡ contentDigests ä¸­ã€‚</p>

<p>æ³¨é‡Š1-4ï¼Œæ„é€  apk ç­¾ååˆ†å—ã€‚</p>

<p>æ³¨é‡Š1-5ï¼Œæ„é€ å¹¶è¿”å›å¸¦ V2 ç­¾åçš„ APKã€‚<br />
åˆ°æ­¤ï¼Œå¯¹ä¸€ä¸ª APK åŠ ä¸Š V2 ç­¾åçš„æµç¨‹å°±èµ°å®Œäº†ã€‚å…¶ä¸­æ³¨é‡Š1-3å’Œæ³¨é‡Š1-4ä¸­çš„ä»£ç é€»è¾‘æ‰æ˜¯æ ¸å¿ƒï¼Œå°†åœ¨ä¸‹é¢å±•å¼€è®²è§£ã€‚<br /></p>

<h1 id="è®¡ç®—-apk-çš„æ‘˜è¦çš„æºç è§£æ">è®¡ç®— apk çš„æ‘˜è¦çš„æºç è§£æ</h1>
<p>åœ¨ä»£ç æ®µ1çš„æ³¨é‡Š1-3å¤„ï¼ŒcomputeContentDigests å‡½æ•°è¿”å›çš„ â€œæ‘˜è¦ç®—æ³•ID - åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦â€ çš„ æ˜ å°„å¯¹ï¼Œå­˜å‚¨åˆ°å˜é‡ contentDigests ä¸­ã€‚<br />
é‚£ä¹ˆè¿™äº›æ˜ å°„å¯¹æ˜¯æ€ä¹ˆè®¡ç®—çš„å‘¢ï¼Ÿæˆ‘ä»¬å»çœ‹å‡½æ•° computeContentDigests çš„æºç ï¼š</p>
<h3 id="ä»£ç æ®µ2">ä»£ç æ®µ2:</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
</pre></td><td class="rouge-code"><pre>    private static Map&lt;Integer, byte[]&gt; computeContentDigests(
            Set&lt;Integer&gt; digestAlgorithms,
            ByteBuffer[] contents) throws DigestException {

        // For each digest algorithm the result is computed as follows:
        // 1. Each segment of contents is split into consecutive chunks of 1 MB in size.
        //    The final chunk will be shorter iff the length of segment is not a multiple of 1 MB.
        //    No chunks are produced for empty (zero length) segments.
        // 2. The digest of each chunk is computed over the concatenation of byte 0xa5, the chunk's
        //    length in bytes (uint32 little-endian) and the chunk's contents.
        // 3. The output digest is computed over the concatenation of the byte 0x5a, the number of
        //    chunks (uint32 little-endian) and the concatenation of digests of chunks of all
        //    segments in-order.

        // å¼•è¿°å®˜ç½‘çš„ä¸­æ–‡ç¿»è¯‘ï¼š
        // a. ç¬¬ 1ã€3 å’Œ 4 éƒ¨åˆ†çš„æ‘˜è¦é‡‡ç”¨ä»¥ä¸‹è®¡ç®—æ–¹å¼ï¼Œç±»ä¼¼äºä¸¤çº§ Merkle æ ‘ã€‚
        // b. æ¯ä¸ªéƒ¨åˆ†éƒ½ä¼šè¢«æ‹†åˆ†æˆå¤šä¸ªå¤§å°ä¸º 1 MBï¼ˆ220 ä¸ªå­—èŠ‚ï¼‰çš„è¿ç»­å—ã€‚æ¯ä¸ªéƒ¨åˆ†çš„æœ€åä¸€ä¸ªå—å¯èƒ½ä¼šçŸ­ä¸€äº›ã€‚
        // c. æ¯ä¸ªå—çš„æ‘˜è¦å‡é€šè¿‡å­—èŠ‚ 0xa5 çš„è¿æ¥ã€å—çš„é•¿åº¦ï¼ˆé‡‡ç”¨å°ç«¯å­—èŠ‚åºçš„ uint32 å€¼ï¼Œä»¥å­—èŠ‚æ•°è®¡ï¼‰å’Œå—çš„å†…å®¹è¿›è¡Œè®¡ç®—ã€‚
        // d. é¡¶çº§æ‘˜è¦é€šè¿‡å­—èŠ‚ 0x5a çš„è¿æ¥ã€å—æ•°ï¼ˆé‡‡ç”¨å°ç«¯å­—èŠ‚åºçš„ uint32 å€¼ï¼‰ä»¥åŠå—çš„æ‘˜è¦çš„è¿æ¥ï¼ˆæŒ‰ç…§å—åœ¨ APK ä¸­æ˜¾ç¤ºçš„é¡ºåºï¼‰è¿›è¡Œè®¡ç®—ã€‚
        // e. æ‘˜è¦ä»¥åˆ†å—æ–¹å¼è®¡ç®—ï¼Œä»¥ä¾¿é€šè¿‡å¹¶è¡Œå¤„ç†æ¥åŠ å¿«è®¡ç®—é€Ÿåº¦ã€‚

        // å¤§è‡´æ€è·¯ï¼š
        // å› ä¸ºå­˜åœ¨å¤šç§æ‘˜è¦ç®—æ³•ï¼Œè¿™é‡Œçš„åšæ³•æ˜¯ï¼Œåˆ†åˆ«é‡‡ç”¨æ¯ä¸€ç§ç®—æ³•ï¼š
        // å¯¹å…¥å‚ contents çš„æ‰€æœ‰åˆ†å—é€ä¸ªè®¡ç®—æ‘˜è¦ï¼Œç„¶åé€ä¸ªç›¸è¿æ„æˆä¸€ä¸ª*åˆ†å—æ‘˜è¦åºåˆ—*ï¼Œ
        // æ¥ç€å†å¯¹è¯¥*åˆ†å—æ‘˜è¦åºåˆ—*è®¡ç®—æ‘˜è¦ï¼Œå¾—åˆ°*åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦*
        // æœ€åï¼Œä»¥ "ç®—æ³•ID-åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦" çš„å½¢å¼å­˜åˆ° map å¹¶è¿”å›ã€‚

        // å…¥å‚è§£æï¼š
        // digestAlgorithms å°±æ˜¯æ‘˜è¦ç®—æ³•çš„é›†åˆï¼Œå…¶å®å°±æ˜¯ä¸¤ç§æ‘˜è¦ç®—æ³•ï¼šSHA256 å’Œ SHA512ï¼›
        // contents å°±æ˜¯ new ByteBuffer[] {beforeCentralDir, centralDir, eocd}ã€‚å³è¦è®¡ç®—æ‘˜è¦çš„å†…å®¹ã€‚

        int chunkCount = 0;
        for (ByteBuffer input : contents) { // éå† {beforeCentralDir, centralDir, eocd}
            chunkCount += getChunkCount(input.remaining(), CONTENT_DIGESTED_CHUNK_MAX_SIZE_BYTES/*1MB*/);// 1MB = 1024KB =1024*1024B
            // ä»¥æ¯ä¸ªå°å—1MBçš„æ ‡å‡†ï¼Œè®¡ç®—ä¸€å…±å¯ä»¥æ‹†åˆ†æˆå¤šå°‘ä¸ªå°å—
        }
        final Map&lt;Integer, byte[]&gt; digestsOfChunks = new HashMap&lt;&gt;(digestAlgorithms.size());
        for (int digestAlgorithm : digestAlgorithms) {
            // éå†ç®—æ³•é›†ï¼Œå³ SHA256 å’Œ SHA512ï¼›

            // å½“å‰ç®—æ³•ä¸‹ï¼Œæ¯ä¸ª1MBåˆ†å—è®¡ç®—å‡ºçš„æ‘˜è¦çš„å­—èŠ‚æ•°
            int digestOutputSizeBytes = getContentDigestAlgorithmOutputSizeBytes(digestAlgorithm);

            // æ–°å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ è¡¨ç¤ºï¼š
            // å½“å‰ç®—æ³•ä¸‹ï¼Œæ‰€æœ‰åˆ†å—çš„æ‘˜è¦çš„åˆå¹¶é›†ï¼Œåˆç§°ä¸ºï¼šåˆ†å—æ‘˜è¦åºåˆ—
            // åŒæ—¶é¢„ç•™äº†å‰5ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼šä¸€å­—èŠ‚çš„0x5a å’Œ å››å­—èŠ‚çš„åº¦å‰ç¼€
            byte[] concatenationOfChunkCountAndChunkDigests =
                    new byte[5 + chunkCount * digestOutputSizeBytes];// å…¶å¤§å°ä¸ºï¼šä¸€å­—èŠ‚ï¼ˆ0x5aï¼‰ + å››å­—èŠ‚ï¼ˆåˆ†å—æ•°ï¼Œä¹Ÿç§°é•¿åº¦å‰ç¼€ï¼‰ + æ‰€æœ‰åˆ†å—æ‘˜è¦çš„å­—èŠ‚æ•°æ€»å’Œ
            // ä¸‹é¢æŠŠå˜é‡ concatenationOfChunkCountAndChunkDigests ç§°ä¸º *å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—*

            // è®¾ç½® *å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—*
            // çš„é¦–å­—èŠ‚ä¸º 0x5a
            concatenationOfChunkCountAndChunkDigests[0] = 0x5a;

            // è®¾ç½® *åˆ†å—å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—* ä¸­
            // è¡¨ç¤ºå—æ•°çš„4ä¸ªå­—èŠ‚ä¸ºå°ç«¯åºï¼Œå³ç¬¬äºŒåˆ°ç¬¬äº”ä¸ªå­—èŠ‚ï¼Œä¸‹æ ‡æ˜¯1ï½4ã€‚
            setUnsignedInt32LittleEngian(
                    chunkCount, concatenationOfChunkCountAndChunkDigests, 1);

            // "ç®—æ³•ID - å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—" æ˜ å°„å¯¹ï¼Œä¹Ÿç§°é”®å€¼å¯¹
            // å­˜åˆ°å˜é‡ digestsOfChunks ä¸­
            digestsOfChunks.put(digestAlgorithm, concatenationOfChunkCountAndChunkDigests);

            // å°ç»“ï¼šæ¯ä¸€ç§ç®—æ³•ï¼Œéƒ½ä¼šå¯¹æ•´ä¸ªapkçš„åˆ†å—åºåˆ—è¿›è¡Œä¸€æ¬¡ *æ‘˜è¦è®¡ç®—*
        }

        // ======ç”¨äºå­˜å‚¨æ‘˜è¦å€¼çš„ç›¸å…³å˜é‡å·²ç»åˆ›å»ºå®Œæ¯•ï¼Œæ¥ä¸‹æ¥å¼€å§‹è®¡ç®—æ‘˜è¦======
        
        int chunkIndex = 0; // åˆ†å—çš„ä¸‹æ ‡
        byte[] chunkContentPrefix = new byte[5]; // åˆ†å—å‰ç¼€ï¼Œ0xa5 + å››å­—èŠ‚çš„å—æ•°
        chunkContentPrefix[0] = (byte) 0xa5;// åˆ†å—å‰ç¼€çš„ç¬¬ä¸€ä¸ªå­—èŠ‚
        // Optimization opportunity: digests of chunks can be computed in parallel.
        for (ByteBuffer input : contents) { // éå† APK çš„ä¸‰éƒ¨åˆ†
            while (input.hasRemaining()) { 
                int chunkSize =
                        Math.min(input.remaining(), CONTENT_DIGESTED_CHUNK_MAX_SIZE_BYTES/*1MB*/);
                final ByteBuffer chunk = getByteBuffer(input, chunkSize);
                // åˆ°æ­¤å¯çŸ¥ï¼Œå¯¹ APk çš„æ¯ä¸€éƒ¨åˆ†ï¼Œå¾ªç¯çš„å–å‡º 1MBçš„å°å—ï¼Œç”¨äºæ‘˜è¦è®¡ç®—
                
                for (int digestAlgorithm : digestAlgorithms) {
                    // éå†ç®—æ³•é›†ï¼Œæ¯ä¸ªç®—æ³•éƒ½ç®—ä¸€éæ‘˜è¦ï¼Œå³ SHA256 å’Œ SHA512ï¼›

                    String jcaAlgorithmName =
                            getContentDigestAlgorithmJcaDigestAlgorithm(digestAlgorithm);
                    MessageDigest md;
                    try {
                        md = MessageDigest.getInstance(jcaAlgorithmName);// æ ¹æ®æ‘˜è¦ç®—æ³•ï¼Œæ„å»ºæ‘˜è¦è®¡ç®—çš„æ‰§è¡Œè€… md
                    } catch (NoSuchAlgorithmException e) {
                        throw new DigestException(
                                jcaAlgorithmName + " MessageDigest not supported", e);
                    }
                    // Reset position to 0 and limit to capacity. Position would've been modified
                    // by the preceding iteration of this loop. NOTE: Contrary to the method name,
                    // this does not modify the contents of the chunk.
                    chunk.clear();
                    setUnsignedInt32LittleEngian(chunk.remaining(), chunkContentPrefix, 1);
                    md.update(chunkContentPrefix);// åˆ†å—å‰ç¼€åŠ å…¥mdï¼Œå‡†å¤‡è®¡ç®—
                    md.update(chunk);// åˆ†å—çº³å…¥mdï¼Œå‡†å¤‡è®¡ç®—

                    // è·å– å½“å‰ç®—æ³•å¯¹åº”çš„ *å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—*ï¼Œè®¡ç®—ç»“æœå°†å­˜äºæ­¤å˜é‡
                    byte[] concatenationOfChunkCountAndChunkDigests =
                            digestsOfChunks.get(digestAlgorithm);

                    // è·å– é¢„æœŸçš„*æ‘˜è¦å­—èŠ‚æ•°*
                    int expectedDigestSizeBytes =
                            getContentDigestAlgorithmOutputSizeBytes(digestAlgorithm);

                    // è·å– å®é™…çš„*æ‘˜è¦å­—èŠ‚æ•°*
                    // ä¸”å°†æ‘˜è¦ç»“æœå­˜äºå˜é‡ *å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—*ï¼Œå³ concatenationOfChunkCountAndChunkDigests
                    int actualDigestSizeBytes =
                            md.digest(
                                    concatenationOfChunkCountAndChunkDigests,
                                    5 + chunkIndex * expectedDigestSizeBytes,
                                    expectedDigestSizeBytes);
                            // è¿™é‡Œè®¡ç®—å¯¹è±¡çš„æ˜¯ä¸Šé¢ update è¿›æ¥çš„ chunkContentPrefix å’Œ chunk çš„æ‘˜è¦
                            // å¹¶ä¸”æŠŠæ‘˜è¦æ•°æ®å†™å…¥åˆ° concatenationOfChunkCountAndChunkDigests è¿™ä¸ªå­—èŠ‚æ•°ç»„çš„æŒ‡å®šä½ç½®
                            // å…¶å®å°±æ˜¯æ ¹æ® chunkIndex ç´¯åŠ ï¼Œé€ä¸ªå¾€åè¡€ã€å†™

                    // é¢„æœŸæ‘˜è¦å­—èŠ‚æ•° å¿…é¡»ç­‰äº å®é™…æ‘˜è¦å­—èŠ‚æ•°ï¼Œå¦åˆ™æŠ›å¼‚å¸¸
                    if (actualDigestSizeBytes != expectedDigestSizeBytes) {
                        throw new DigestException(
                                "Unexpected output size of " + md.getAlgorithm()
                                        + " digest: " + actualDigestSizeBytes);
                    }
                }
                chunkIndex++;
            }
        }

        // è®¡ç®—ç»“æœï¼ˆå³*å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—*ï¼‰
        // å­˜äºå˜é‡ concatenationOfChunkCountAndChunkDigestsï¼Œ
        // è€Œè¯¥å˜é‡å­˜äº digestsOfChunks
        //====== åˆ†å—æ‘˜è¦è®¡ç®—ç»“æŸï¼Œå¾—åˆ°*å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—* ======          

        Map&lt;Integer, byte[]&gt; result = new HashMap&lt;&gt;(digestAlgorithms.size());

        for (Map.Entry&lt;Integer, byte[]&gt; entry : digestsOfChunks.entrySet()) {
            int digestAlgorithm = entry.getKey();
            byte[] concatenationOfChunkCountAndChunkDigests = entry.getValue();
            String jcaAlgorithmName = getContentDigestAlgorithmJcaDigestAlgorithm(digestAlgorithm);
            MessageDigest md;
            try {
                md = MessageDigest.getInstance(jcaAlgorithmName);
            } catch (NoSuchAlgorithmException e) {
                throw new DigestException(jcaAlgorithmName + " MessageDigest not supported", e);
            }
            // æ­¤å¤„å¯¹ *å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—* è¿™æ•´ä¸ªå˜é‡ï¼Œåˆè¿›è¡Œæ¥ä¸€æ¬¡æ‘˜è¦è®¡ç®—
            // å¾—åˆ° æ‘˜è¦ç®—æ³•ID - å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦ï¼Œ
            // ç®€ç§° ç®—æ³•ID - åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦
            // å­˜äº result
            result.put(digestAlgorithm, md.digest(concatenationOfChunkCountAndChunkDigests));
        }

        //====== åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦è®¡ç®—ç»“æŸï¼Œå¾—åˆ° *åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦* ======  

        return result; // â€œæ‘˜è¦ç®—æ³•ID - åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦â€çš„ Map
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ä¸Šè¿°æºç æ®µä¸­å·²ç»å¸¦æœ‰è¯¦ç»†çš„æ³¨é‡Šï¼Œæ•´ä¸ªå‡½æ•°çš„é€»è¾‘ä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼š<br />
ç¬¬ä¸€æ­¥ï¼šå¾—åˆ° <strong>å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—</strong>ï¼Œç®€ç§° <strong>åˆ†å—æ‘˜è¦åºåˆ—</strong><br />
ç¬¬äºŒæ­¥ï¼šå¾—åˆ° <strong>å¸¦å—æ•°çš„åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦</strong>ï¼Œç®€ç§° <strong>åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦</strong><br />
æ¥ç€é™„ä¸Šä¸¤å¼ å›¾ç¤ºï¼Œæ¥å±•ç¤ºæ‘˜è¦è®¡ç®—çš„å¤§è‡´æ€è·¯ï¼Œç¬¬ä¸€å¼ ä¸ºå®˜æ–¹æ–‡æ¡£çš„å›¾ï¼š
<img src="http://guoke24.top/img/apk-integrity-protection.png" alt="" /><br />
<img src="http://guoke24.top/img/è®¡ç®—APKçš„æ‘˜è¦.png" alt="" /><br />
ç”±ä¸Šè¿°ä»£ç æ®µå’Œå›¾ç¤ºï¼Œæˆ‘ä»¬å¤§è‡´æ¸…æ¥šäº†å¯¹ä¸€ä¸ª APK æ‘˜è¦çš„åŒé‡è®¡ç®—çš„è¿‡ç¨‹ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯ <strong>åˆ†å—æ‘˜è¦åºåˆ—çš„åˆ†å—</strong>ã€‚<br /></p>

<h1 id="æ„é€ -apk-ç­¾ååˆ†å—">æ„é€  apk ç­¾ååˆ†å—</h1>
<p>å†å›é¡¾ä¸€ä¸‹ä»£ç æ®µ1çš„æ³¨é‡Š1-4å¤„çš„ä»£ç ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>    // Sign the digests and wrap the signatures and signer info into an APK Signing Block.
    ByteBuffer apkSigningBlock =
        ByteBuffer.wrap(generateApkSigningBlock(signerConfigs, contentDigests));

</pre></td></tr></tbody></table></code></pre></div></div>

<p>generateApkSigningBlock å‡½æ•°è¿”å›çš„å·²ç»æ˜¯å®Œæ•´çš„ apk ç­¾ååˆ†å—ï¼ŒByteBuffer.wrap ä»…ä»…æ˜¯åšä¸€ä¸ªåŒ…è£…ã€‚
æ¥ç€çœ‹ generateApkSigningBlock å‡½æ•°çš„æºç ï¼š</p>
<h3 id="ä»£ç æ®µ3å®Œæ•´çš„-apk-ç­¾ååˆ†å—">ä»£ç æ®µ3ï¼Œå®Œæ•´çš„ apk ç­¾ååˆ†å—:</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>    private static byte[] generateApkSigningBlock(
            List&lt;SignerConfig&gt; signerConfigs,
            Map&lt;Integer, byte[]&gt; contentDigests) throws InvalidKeyException, SignatureException {

        // 3-1
        // æ­¤å¤„å…¥å‚çš„æ˜¯ contentDigestsï¼Œå³ map&lt; ç®—æ³•ID - åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦ &gt;
        byte[] apkSignatureSchemeV2Block =
                generateApkSignatureSchemeV2Block(signerConfigs, contentDigests);
                // è¯¥å‡½æ•° ä¼šäº§ç”Ÿ æ˜¯åŸç”ŸV2ç­¾ååˆ†å—valueå€¼

        // 3-2
        // æ­¤å¤„çš„å…¥å‚çš„ apkSignatureSchemeV2Block æ˜¯åŸç”ŸV2ç­¾ååˆ†å—valueå€¼
        return generateApkSigningBlock(apkSignatureSchemeV2Block);
        // æ­¤å¤„è¿”å›çš„å·²ç»æ˜¯å®Œæ•´çš„ apk ç­¾ååˆ†å—
        // å³åŠ ä¸Šå‰åsizeï¼Œprelenï¼ŒIDï¼Œmagicï¼Œ
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç é‡Œçš„æ³¨é‡Š3-1å’Œ3-2éƒ½æœ‰ä¸­æåˆ°ï¼Œå˜é‡ apkSignatureSchemeV2Block æ˜¯åŸç”ŸV2ç­¾ååˆ†å—valueå€¼ï¼Œ<br />
å›é¡¾ä¸€ä¸‹ V2 ç­¾å APk çš„æ€»ä½“ç»“æ„ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>apk
{
    beforeCentralDir,
    apkSigningBlock,// apk ç­¾ååˆ†å—
	{
		blockSizeFieldValue,
		pairSizeFieldValue,
		APK_SIGNATURE_SCHEME_V2_BLOCK_ID,
		apkSignatureSchemeV2Blockï¼Œ// value å€¼ï¼Œå†…å« â€œID-å€¼â€å¯¹ï¼ŒV2 åˆ†å—
		{
			len-signers[len-signer]
			{
				signer
				{
					len-signedData,
					{
						len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],
						len-certificates["len-certificate"],
						len-new byte[0],
					}
					len-signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"],
					len-publicKey
				}
			}
		}
		blockSizeFieldValue,
		APK_SIGNING_BLOCK_MAGIC,
	}
    centralDir,
    eocd,
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°ä»£ç æ®µ3ä¸­æåˆ°çš„ apkSignatureSchemeV2Block ï¼Œæ­£æ˜¯æ­¤å¤„çš„ apkSignatureSchemeV2Blockã€‚<br />
ç»§ç»­çœ‹ä»£ç æ®µ3çš„æ³¨é‡Š3-1å¤„ï¼Œè°ƒç”¨äº†å‡½æ•° generateApkSignatureSchemeV2Blockï¼Œè¿”å›å€¼ apkSignatureSchemeV2Blockã€‚</p>
<h3 id="ä»£ç æ®µ4v2-ç­¾ååˆ†å—">ä»£ç æ®µ4ï¼ŒV2 ç­¾ååˆ†å—:</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>    private static byte[] generateApkSignatureSchemeV2Block(
            List&lt;SignerConfig&gt; signerConfigs,
            Map&lt;Integer, byte[]&gt; contentDigests) throws InvalidKeyException, SignatureException {
        // FORMAT:
        // * length-prefixed sequence of length-prefixed signer blocks.
        List&lt;byte[]&gt; signerBlocks = new ArrayList&lt;&gt;(signerConfigs.size());
        int signerNumber = 0;
        for (SignerConfig signerConfig : signerConfigs) {
            signerNumber++;
            byte[] signerBlock;
            try {
                signerBlock = generateSignerBlock(signerConfig, contentDigests); //4-1
            } catch (InvalidKeyException e) {
                throw new InvalidKeyException("Signer #" + signerNumber + " failed", e);
            } catch (SignatureException e) {
                throw new SignatureException("Signer #" + signerNumber + " failed", e);
            }
            signerBlocks.add(signerBlock);
        }
        return encodeAsSequenceOfLengthPrefixedElements( //4-2
                new byte[][] {
                        encodeAsSequenceOfLengthPrefixedElements(signerBlocks), //4-3
                });
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>éå† signerConfigsï¼Œæ¯ä¸ª signerConfigs éƒ½æ„å»ºä¸€ä¸ªå¯¹åº”çš„ signerBlockï¼Œæœ€ç»ˆæ·»åŠ åˆ°å˜é‡ signerBlocksã€‚<br />
æ‰€ä»¥è¯´ï¼Œæœ‰å¤šå°‘ä¸ªç­¾åè€…ï¼Œå°±æœ‰å¤šå°‘ä¸ª signerBlockã€‚<br />
è€Œ signerBlock æ­£æ˜¯å¯¹åº”äº† apkSignatureSchemeV2Block çš„ç±»jsonç»“æ„ä¸­çš„ signerã€‚<br />
ç°åœ¨æŠŠ apkSignatureSchemeV2Block çš„ç±»jsonç»“æ„å•ç‹¬æ‹å‡ºæ¥ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>apkSignatureSchemeV2Blockï¼Œ// value å€¼ï¼Œå†…å« â€œID-å€¼â€å¯¹ï¼ŒV2 åˆ†å—  
{
	len-signers[len-signer]
	{
		signer
		{
			len-signedData, //ç­¾åæ•°æ®
			{
				len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],  
				len-certificates["len-certificate"], //ä»ç¬¬ä¸€ä¸ª certificate å†…çš„å…¬é’¥ï¼Œå¯¹åº”ç­¾åçš„ç§é’¥
				len-additional_attributes["len-(ID-(len-attribute))"],  
			}
			len-signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"], //ç­¾åå€¼ 
			len-publicKey // å…¬é’¥ï¼Œç¬¬ä¸€ä¸ª certificate å†…å–åˆ°çš„ 
		}
    }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ç€çœ‹ä»£ç æ®µ4çš„æ³¨é‡Š4-1ï¼Œæ„é€  signerBlockï¼Œè°ƒç”¨äº†å‡½æ•° generateSignerBlockï¼Œç›¸å…³æºç ï¼š</p>
<h3 id="ä»£ç æ®µ5æ„é€ å•ä¸ª-signer">ä»£ç æ®µ5ï¼Œæ„é€ å•ä¸ª Signer:</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
</pre></td><td class="rouge-code"><pre>    private static byte[] generateSignerBlock(
            SignerConfig signerConfig,
            Map&lt;Integer, byte[]&gt; contentDigests) throws InvalidKeyException, SignatureException {
        // å…¥å‚çš„ signerConfigï¼Œå³ç­¾åè€…é…ç½®ï¼Œå†…éƒ¨å¸¦æœ‰*è¯ä¹¦åºåˆ—*å’Œ*ç­¾åç®—æ³•åºåˆ—*
        // å…¥å‚çš„ contentDigests å°±æ˜¯ map&lt; æ‘˜è¦ç®—æ³•ID - åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦ &gt;

        if (signerConfig.certificates.isEmpty()) {
            throw new SignatureException("No certificates configured for signer");
        }

        // æ ¹æ®å…¥å‚ signerConfigï¼Œè·å¾— å…¬é’¥
        PublicKey publicKey = signerConfig.certificates.get(0).getPublicKey();
        byte[] encodedPublicKey = encodePublicKey(publicKey);

        // æ–°å»º signedData å®ä¾‹
        V2SignatureSchemeBlock.SignedData signedData = new V2SignatureSchemeBlock.SignedData();

        // æ ¹æ®å…¥å‚ signerConfigï¼Œè·å¾— è¯ä¹¦åºåˆ—ï¼Œå¹¶èµ‹å€¼ç»™ signedData.certificates
        try {
            signedData.certificates = encodeCertificates(signerConfig.certificates);
        } catch (CertificateEncodingException e) {
            throw new SignatureException("Failed to encode certificates", e);
        }

        List&lt;Pair&lt;Integer, byte[]&gt;&gt; digests =
                new ArrayList&lt;&gt;(signerConfig.signatureAlgorithms.size());

        // éå†å…¥å‚ signerConfig çš„ç®—æ³•åºåˆ—ï¼šsignatureAlgorithms
        for (int signatureAlgorithm : signerConfig.signatureAlgorithms) {

            // å–åˆ° æ‘˜è¦ç®—æ³•ID
            int contentDigestAlgorithm =
                    getSignatureAlgorithmContentDigestAlgorithm(signatureAlgorithm);
                    // æ ¹æ® ç­¾åç®—æ³•çš„ç±»å‹ï¼Œè¿”å› æ‘˜è¦ç®—æ³•ï¼Œå†…æœ‰ä¸€ä¸ªç®€å•å¯¹åº”è¡¨

            // å–åˆ° apkçš„åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦
            byte[] contentDigest = contentDigests.get(contentDigestAlgorithm);

            if (contentDigest == null) {
                throw new RuntimeException(
                        getContentDigestAlgorithmJcaDigestAlgorithm(contentDigestAlgorithm)
                                + " content digest for "
                                + getSignatureAlgorithmJcaSignatureAlgorithm(signatureAlgorithm)
                                + " not computed");
            }

            // æ„é€  "ç­¾åç®—æ³•ID-æ‘˜è¦åºåˆ—"ï¼Œä¿å­˜åˆ°å˜é‡ digests
            digests.add(Pair.create(signatureAlgorithm, contentDigest));
        }

        signedData.digests = digests;// å¤šä¸ª"ç­¾åç®—æ³•ID-æ‘˜è¦"å¯¹

        V2SignatureSchemeBlock.Signer signer = new V2SignatureSchemeBlock.Signer();


        // ====== å¼€å§‹æ„é€ å¾…ç­¾åæ•°æ®ï¼šsigner.signedData ======

        // FORMAT:
        // * length-prefixed sequence of length-prefixed digests:
        //   * uint32: signature algorithm ID
        //   * length-prefixed bytes: digest of contents
        // * length-prefixed sequence of certificates:
        //   * length-prefixed bytes: X.509 certificate (ASN.1 DER encoded).
        // * length-prefixed sequence of length-prefixed additional attributes:
        //   * uint32: ID
        //   * (length - 4) bytes: value
        signer.signedData = encodeAsSequenceOfLengthPrefixedElements(new byte[][] {
                encodeAsSequenceOfLengthPrefixedPairsOfIntAndLengthPrefixedBytes(signedData.digests),//x-1
                encodeAsSequenceOfLengthPrefixedElements(signedData.certificates),//x-2
                new byte[0],//x-3
        });

        // x-1å¤„ï¼Œå‡½æ•° encodeAsSequenceOfLengthPrefixedPairsOfIntAndLengthPrefixedBytesï¼Œ
        // å…¥å‚æ˜¯ digests["ç­¾åç®—æ³•ID-æ‘˜è¦"]
        // è¿”å›å€¼æ˜¯ digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"]

        // x-2å¤„ï¼Œå‡½æ•° encodeAsSequenceOfLengthPrefixedElements
        // å…¥å‚æ˜¯ certificates["certificate"],
        // è¿”å›å€¼æ˜¯ certificates["len-certificate"]

        // x-3å¤„ï¼Œæ˜¯é™„åŠ æ•°æ®ï¼ŒåŸç”Ÿ V2 ç­¾åä¸å¸¦é™„åŠ æ•°æ®ã€‚

        // æœ€ç»ˆï¼Œsigner.signedData æ ¼å¼æ˜¯ï¼š
        // signedData
        // {
        //     len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],
        //     len-certificates["len-certificate"],
        //     len-additional_attributes["len-(ID-(len-attribute))"],
        // }

        // ====== å®Œæˆæ„é€ å¾…ç­¾åæ•°æ®ï¼šsigner.signedData ======

        // ====== å¼€å§‹æ„é€ ç­¾åå€¼ï¼šsigner.signatures ======
        signer.publicKey = encodedPublicKey;
        signer.signatures = new ArrayList&lt;&gt;();
        for (int signatureAlgorithm : signerConfig.signatureAlgorithms) {
            Pair&lt;String, ? extends AlgorithmParameterSpec&gt; signatureParams =
                    getSignatureAlgorithmJcaSignatureAlgorithm(signatureAlgorithm);
            String jcaSignatureAlgorithm = signatureParams.getFirst();
            AlgorithmParameterSpec jcaSignatureAlgorithmParams = signatureParams.getSecond();
            byte[] signatureBytes;
            try {
                Signature signature = Signature.getInstance(jcaSignatureAlgorithm);
                signature.initSign(signerConfig.privateKey);// ä½¿ç”¨ç§é’¥ç­¾å
                if (jcaSignatureAlgorithmParams != null) {
                    signature.setParameter(jcaSignatureAlgorithmParams);
                }
                signature.update(signer.signedData);// å¯¹æ„é€ å¥½çš„æ•´ä¸ª signer.signedData ï¼Œä½¿ç”¨ä¸Šè¿°å¼•å…¥çš„ç§é’¥ï¼Œè¿›è¡Œç­¾å
                signatureBytes = signature.sign();  // ç­¾ååçš„æ•°æ®
            } catch (InvalidKeyException e) {
                throw new InvalidKeyException("Failed sign using " + jcaSignatureAlgorithm, e);
            } catch (NoSuchAlgorithmException | InvalidAlgorithmParameterException
                    | SignatureException e) {
                throw new SignatureException("Failed sign using " + jcaSignatureAlgorithm, e);
            }

            // æµ‹è¯• *å…¬é’¥* èƒ½å¦è§£ *ç§é’¥ç­¾ååçš„æ•°æ®*
            try {
                Signature signature = Signature.getInstance(jcaSignatureAlgorithm);
                signature.initVerify(publicKey);
                if (jcaSignatureAlgorithmParams != null) {
                    signature.setParameter(jcaSignatureAlgorithmParams);
                }
                signature.update(signer.signedData);
                if (!signature.verify(signatureBytes)) {
                    throw new SignatureException("Signature did not verify");
                }
            } catch (InvalidKeyException e) {
                throw new InvalidKeyException("Failed to verify generated " + jcaSignatureAlgorithm
                        + " signature using public key from certificate", e);
            } catch (NoSuchAlgorithmException | InvalidAlgorithmParameterException
                    | SignatureException e) {
                throw new SignatureException("Failed to verify generated " + jcaSignatureAlgorithm
                        + " signature using public key from certificate", e);
            }//end æµ‹è¯•*å…¬é’¥*èƒ½å¦è§£*ç§é’¥ç­¾ååçš„æ•°æ®*

            // åˆ°æ­¤ï¼Œé€šè¿‡éªŒéªŒè¯ï¼Œ*å…¬é’¥* å¯ä»¥è§£ *ç§é’¥*
            // æ„é€ pairå¯¹ï¼Œç»“æ„ä¸º"ç­¾åç®—æ³•ID-ç­¾ååæ•°æ®"
            signer.signatures.add(Pair.create(signatureAlgorithm, signatureBytes));
        }
        // ====== å®Œæˆæ„é€ ç­¾åå€¼ï¼šsigner.signatures ======

        // FORMAT:
        // * length-prefixed signed data
        // * length-prefixed sequence of length-prefixed signatures:
        //   * uint32: signature algorithm ID
        //   * length-prefixed bytes: signature of signed data
        // * length-prefixed bytes: public key (X.509 SubjectPublicKeyInfo, ASN.1 DER encoded)
        return encodeAsSequenceOfLengthPrefixedElements(
                new byte[][] {
                        signer.signedData,
                        encodeAsSequenceOfLengthPrefixedPairsOfIntAndLengthPrefixedBytes(
                                signer.signatures),//y-1
                        signer.publicKey,
                });
        // y-1å¤„ï¼Œå…¥å‚çš„æ˜¯ signer.signatures["ç­¾åç®—æ³•ID-ç­¾åå€¼"]ï¼Œ
        // è¿”å›å€¼æ˜¯ signer.signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"]

        // æœ€ç»ˆï¼Œreturn çš„å€¼æ˜¯ï¼š
        // 		signer
        //		{
        //			len-signedData, //å¾…ç­¾åæ•°æ®
        //			{
        //				len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],  
        //				len-certificates["len-certificate"], 
        //				len-additional_attributes["len-(ID-(len-attribute))"],  
        //			}
        //			len-signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"],// ç­¾åå€¼
        //			len-publicKey // å…¬é’¥ï¼Œç¬¬ä¸€ä¸ª certificate å†…å–åˆ°çš„ 
        //		} 
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ç€çœ‹ä»£ç æ®µ4çš„æ³¨é‡Š4-2ï¼Œæ³¨é‡Š4-3å¤„ï¼Œ</p>
<h3 id="å›é¡¾ä»£ç æ®µ4">å›é¡¾ä»£ç æ®µ4ï¼š</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>    private static byte[] generateApkSignatureSchemeV2Block(
            List&lt;SignerConfig&gt; signerConfigs,
            Map&lt;Integer, byte[]&gt; contentDigests) throws InvalidKeyException, SignatureException {
        // FORMAT:
        // * length-prefixed sequence of length-prefixed signer blocks.
        List&lt;byte[]&gt; signerBlocks = new ArrayList&lt;&gt;(signerConfigs.size());
        int signerNumber = 0;
        for (SignerConfig signerConfig : signerConfigs) {
            signerNumber++;
            byte[] signerBlock;
            try {
                signerBlock = generateSignerBlock(signerConfig, contentDigests); //4-1
            } catch (InvalidKeyException e) {
                throw new InvalidKeyException("Signer #" + signerNumber + " failed", e);
            } catch (SignatureException e) {
                throw new SignatureException("Signer #" + signerNumber + " failed", e);
            }
            signerBlocks.add(signerBlock);
        }
        return encodeAsSequenceOfLengthPrefixedElements( //4-2
                new byte[][] {
                        encodeAsSequenceOfLengthPrefixedElements(signerBlocks), //4-3
                });
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç”±ä¸Šè¿°æºç å¯çŸ¥ï¼Œæ³¨é‡Š4-3å¤„ï¼Œå‡½æ•° encodeAsSequenceOfLengthPrefixedElements çš„å…¥å‚ signerBlocks çš„æ ¼å¼ä¸ºï¼š<br />
<code class="highlighter-rouge">signers[signer]</code>ï¼Œè¿”å›å€¼ä¸ºï¼š<code class="highlighter-rouge">signers[len-signer]</code>ï¼›</p>

<p>æ³¨é‡Š4-2å¤„ï¼Œå‡½æ•° encodeAsSequenceOfLengthPrefixedElements çš„å…¥å‚ä¸º <code class="highlighter-rouge">signers[len-signer]</code>ï¼Œ<br />
è¿”å›å€¼ä¸ºï¼š<code class="highlighter-rouge">len-signers[len-signer]</code>ï¼›</p>

<p>æ‰€ä»¥ï¼Œä»£ç æ®µ4ä¸­çš„å‡½æ•° generateApkSignatureSchemeV2Block æœ€ç»ˆçš„è¿”å›å€¼ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä»£ç æ®µ3ä¸­æ³¨é‡Š3-1å¤„çš„å˜é‡ apkSignatureSchemeV2Blockï¼Œ
å…¶å€¼çš„æ ¼å¼ä¸ºï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>apkSignatureSchemeV2Blockï¼Œ// value å€¼ï¼Œå†…å« â€œID-å€¼â€å¯¹ï¼ŒV2 åˆ†å—  
{
	len-signers[len-signer]
	{
		signer
		{
			len-signedData, //ç­¾åæ•°æ®
			{
				len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],  
				len-certificates["len-certificate"], //ä»ç¬¬ä¸€ä¸ª certificate å†…çš„å…¬é’¥ï¼Œå¯¹åº”ç­¾åçš„ç§é’¥
				len-additional_attributes["len-(ID-(len-attribute))"],  
			}
			len-signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"], //ç­¾åå€¼ 
			len-publicKey // å…¬é’¥ï¼Œç¬¬ä¸€ä¸ª certificate å†…å–åˆ°çš„ 
		}
    }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å†çœ‹ä»£ç æ®µ3ä¸­çš„æ³¨é‡Š3-2ï¼Œ</p>
<h3 id="å›é¡¾ä»£ç æ®µ3">å›é¡¾ä»£ç æ®µ3:</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>    private static byte[] generateApkSigningBlock(
            List&lt;SignerConfig&gt; signerConfigs,
            Map&lt;Integer, byte[]&gt; contentDigests) throws InvalidKeyException, SignatureException {

        // 3-1
        // æ­¤å¤„å…¥å‚çš„æ˜¯ contentDigestsï¼Œå³ map&lt; ç®—æ³•ID - åˆ†å—æ‘˜è¦åºåˆ—çš„æ‘˜è¦ &gt;
        byte[] apkSignatureSchemeV2Block =
                generateApkSignatureSchemeV2Block(signerConfigs, contentDigests);
                // è¯¥å‡½æ•° ä¼šäº§ç”Ÿ æ˜¯åŸç”ŸV2ç­¾ååˆ†å—valueå€¼

        // 3-2
        // æ­¤å¤„çš„å…¥å‚çš„ apkSignatureSchemeV2Block æ˜¯åŸç”ŸV2ç­¾ååˆ†å—valueå€¼
        return generateApkSigningBlock(apkSignatureSchemeV2Block);
        // æ­¤å¤„è¿”å›çš„å·²ç»æ˜¯å®Œæ•´çš„ apk ç­¾ååˆ†å—
        // å³åŠ ä¸Šå‰åsizeï¼Œprelenï¼ŒIDï¼Œmagicï¼Œ
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ³¨é‡Š3-2å¤„ï¼Œè°ƒç”¨å‡½æ•° generateApkSigningBlockï¼Œçœ‹å…¶æºç ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>    private static byte[] generateApkSigningBlock(byte[] apkSignatureSchemeV2Block) {
        // FORMAT:
        // uint64:  size (excluding this field)
        // repeated ID-value pairs:
        //     uint64:           size (excluding this field)
        //     uint32:           ID
        //     (size - 4) bytes: value
        // uint64:  size (same as the one above)
        // uint128: magic
        int resultSize =
                8 // size
                        + 8 + 4 + apkSignatureSchemeV2Block.length // v2Block as ID-value pair
                        + 8 // size
                        + 16 // magic
                ;
        ByteBuffer result = ByteBuffer.allocate(resultSize);
        result.order(ByteOrder.LITTLE_ENDIAN);
        long blockSizeFieldValue = resultSize - 8;
        result.putLong(blockSizeFieldValue);
        long pairSizeFieldValue = 4 + apkSignatureSchemeV2Block.length;
        result.putLong(pairSizeFieldValue);
        result.putInt(APK_SIGNATURE_SCHEME_V2_BLOCK_ID);
        result.put(apkSignatureSchemeV2Block);
        result.putLong(blockSizeFieldValue);
        result.put(APK_SIGNING_BLOCK_MAGIC);
        return result.array();
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¯¥å‡½æ•°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå…¶è¿”å›å€¼çš„æ ¼å¼ä¸ºï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>    apkSigningBlock,// apk ç­¾ååˆ†å—
	{
		blockSizeFieldValue,
		pairSizeFieldValue,
		APK_SIGNATURE_SCHEME_V2_BLOCK_ID,
		apkSignatureSchemeV2Blockï¼Œ// value å€¼ï¼Œå†…å« â€œID-å€¼â€å¯¹ï¼ŒV2 åˆ†å—
		{
			len-signers[len-signer]
			{
				signer
				{
					len-signedData,
					{
						len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],
						len-certificates["len-certificate"],
						len-new byte[0],
					}
					len-signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"],
					len-publicKey
				}
			}
		}
		blockSizeFieldValue,
		APK_SIGNING_BLOCK_MAGIC,
	}
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ¥ç€å†å›é¡¾ä»£ç æ®µ1çš„æ³¨é‡Š1-4å¤„ï¼Œå…¶å˜é‡ apkSigningBlock å°±æ˜¯ ä»£ç æ®µ3çš„3-2æ³¨é‡Šçš„ generateApkSigningBlock è¿”å›çš„ ï¼Œ</p>
<h3 id="å›é¡¾ä»£ç æ®µ1">å›é¡¾ä»£ç æ®µ1ï¼š</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>    public static ByteBuffer[] sign(
            ByteBuffer inputApk,
            List&lt;SignerConfig&gt; signerConfigs)
            throws ApkParseException, InvalidKeyException, SignatureException {

        ......


        // 1-4
        // Sign the digests and wrap the signatures and signer info into an APK Signing Block.
        ByteBuffer apkSigningBlock =
                ByteBuffer.wrap(generateApkSigningBlock(signerConfigs, contentDigests));

		......

		// 1-5
        // Insert APK Signing Block immediately before the ZIP Central Directory.
        return new ByteBuffer[] {
                beforeCentralDir,
                apkSigningBlock,
                centralDir,
                eocd,
        };
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æœ€ç»ˆï¼Œæ³¨é‡Š1-5å¤„çš„ sign å‡½æ•° return çš„å€¼çš„æ ¼å¼å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰ V2 ç­¾åçš„ APK çš„å­—èŠ‚æ•°ç»„ï¼Œå…¶æ ¼å¼å¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>apk
{
    beforeCentralDir,
    apkSigningBlock,// apk ç­¾ååˆ†å—
	{
		blockSizeFieldValue,
		pairSizeFieldValue,
		APK_SIGNATURE_SCHEME_V2_BLOCK_ID,
		apkSignatureSchemeV2Blockï¼Œ// value å€¼ï¼Œå†…å« â€œID-å€¼â€å¯¹ï¼ŒV2 åˆ†å—
		{
			len-signers[len-signer]
			{
				signer
				{
					len-signedData,
					{
						len-digests["len-(ç­¾åç®—æ³•ID-(len-æ‘˜è¦))"],
						len-certificates["len-certificate"],
						len-new byte[0],
					}
					len-signatures["len-(ç­¾åç®—æ³•ID-(len-signature))"],
					len-publicKey
				}
			}
		}
		blockSizeFieldValue,
		APK_SIGNING_BLOCK_MAGIC,
	}
    centralDir,
    eocd,
}
</pre></td></tr></tbody></table></code></pre></div></div>

:ET