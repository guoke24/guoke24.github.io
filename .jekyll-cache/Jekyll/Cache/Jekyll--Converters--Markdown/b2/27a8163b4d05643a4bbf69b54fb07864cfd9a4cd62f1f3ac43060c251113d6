I"Bš<h1 id="å‰è¨€">å‰è¨€</h1>
<p>å‚è€ƒæ–‡ç« ï¼š
[å‡¶æ®‹çš„ç¨‹åºå‘˜-View çš„å·¥ä½œæµç¨‹] ( https://blog.csdn.net/qian520ao/article/details/78657084 )
[Android æºç åˆ†æ - Viewçš„measureã€layoutã€drawä¸‰å¤§æµç¨‹] ( https://www.jianshu.com/p/aa3b1f9717b7 )
[æ·±å…¥ç†è§£MeasureSpec] ( https://www.jianshu.com/p/a790982fd20e )
æœ¬æ–‡ç« çš„æºç ï¼Œå¯ä»¥å»è¯¥é“¾æ¥ <a href="https://www.androidos.net.cn/android/9.0.0_r8/xref"> Android9.0 - API28 </a>  ç›´æ¥æœç´¢ï¼Œæµè§ˆã€‚
æˆ–è€… AndroidStudio æŸ¥çœ‹ sdk ä¸­ /sdk/sources/android-28/android è·¯å¾„ä¸‹çš„æºç ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p>

<h1 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h1>
<p>Android æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¹³å°ï¼Œå¯¹äº Android APP å¼€å‘è€…æ¥è¯´ï¼ŒAndroid æ˜¯ä¸€ä¸ªå¤§æ¡†æ¶ã€‚Android OS æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç§»åŠ¨ç»ˆç«¯çš„æ“ä½œç³»ç»Ÿï¼Œå…¶è§¦æ‘¸æ“ä½œæ˜¯äººæœºäº¤äº’ä¸­çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œå› è€Œå¯¹äº APP å¼€å‘è€…æ¥è¯´ï¼Œå¦‚ä½•æ„å»ºå‡ºä¼˜é›…ç¾è§‚ä¸”äººæ€§åŒ–çš„UIç•Œé¢æ˜¯éå¸¸é‡è¦çš„ä¸€é¡¹æŠ€èƒ½ã€‚<br /></p>

<p>æƒ³è¦å­¦ä¹ å¦‚ä½•åšå‡ºä¸€äº›å¥½çœ‹çš„UIç•Œé¢ï¼Œå¯¹ View çš„å·¥ä½œåŸç†çš„äº†è§£æ˜¯å¿…ä¸å¯å°‘çš„ã€‚<br />
View çš„å·¥ä½œåŸç†ï¼Œåœ¨ç½‘ä¸Šçœ‹äº†å¾ˆå¤šè®²è§£çš„æ–‡ç« ï¼Œä¹Ÿçœ‹äº†å¾ˆå¤šæºç ï¼Œä½†æœ‰å¥è€è¯ï¼šçº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚æ•…è€Œè¡ŒåŠ¨èµ·æ¥ï¼Œå†™ä¸‹è¿™ç¯‡æ–‡ç« ï¼Œæ¢³ç†äº† View çš„å·¥ä½œåŸç†çš„ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œç•™ä½œä»¥åå‚è€ƒã€‚<br /></p>

<p>åœ¨å†™è¯¥æ–‡ç« ä¹‹å‰ï¼Œæˆ‘ä¸€ç›´åœ¨æƒ³ï¼Œæ–‡ç« è¦ä»¥æ€æ ·çš„ç»“æ„ï¼Œæ‰èƒ½æ¯”è¾ƒæµç•…ï¼Œæ¸…æ™°çš„é˜è¿°é‚£äº›å¤æ‚åˆåµŒå¥—åŒ…å«çš„çŸ¥è¯†ç‚¹å‘¢ï¼Ÿæœ‰æ—¶å€™ï¼Œè¶Šæƒ³å†™å¾—å¤ªæ¸…æ¥šï¼Œå°±è¶Šéš¾åŠ¨æ‰‹ã€‚ä¸å¦‚ç”¨æœ€æœ´ç´ çš„æ–¹å¼ï¼Œå¯¹äºå¤æ‚çš„çŸ¥è¯†ç‚¹æ¢³ç†ï¼Œé‡‡å–æ€»åˆ†çš„ç»“æ„ï¼Œå…ˆæ€»ç»“å†å±•å¼€çš„æ–¹å¼æ¥è¡Œæ–‡ã€‚äºæ˜¯ï¼Œæ€»åˆ†ç»“æ„å°†æ˜¯æœ¬æ–‡çš„æ¡†æ¶ã€‚</p>

<h1 id="æ€»è§ˆ">æ€»è§ˆ</h1>

<h2 id="view-å’Œ-viewgroup-çš„æ¦‚å¿µ">View å’Œ ViewGroup çš„æ¦‚å¿µ</h2>
<p>View æ˜¯ä¸€ä¸ªè§†å›¾ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ§ä»¶ï¼Œå®ƒæ˜¯å±•ç¤ºæŸç§ç±»å‹å†…å®¹çš„å•ä½“ï¼Œæ˜¯æ„æˆå¤æ‚ç•Œé¢çš„åŸºæœ¬å•ä½ã€‚View å¯ä»¥æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼Œä¸€ä¸ªè¾“å…¥æ¡†æˆ–ä¸€å¼ å›¾ç‰‡ç­‰ç­‰ã€‚ä¸€ä¸ªå¤æ‚ç•Œé¢ï¼Œä¼šæœ‰å¤šä¸ª View æ„æˆï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå°±å‡ºç°äº†åˆ†ç»„å½’çº³çš„éœ€æ±‚ï¼Œå¤äººäº‘ï¼Œæ ¼ç‰©è‡´çŸ¥ï¼Œé‚£æ”¾åˆ°è¿™é‡Œå°±æ˜¯éœ€è¦ä¸€ä¸ª View çš„å®¹å™¨ï¼Œä»¥ä¾¿å°† View åˆ†ç»„ï¼Œè¿™ä¸ª View çš„å®¹å™¨ï¼Œå°±æ˜¯ ViewGroupã€‚ViewGroup æ˜¯ View çš„å­ç±»ï¼ŒViewGroup å¯ä»¥å®¹çº³ View å’Œ ViewGroupã€‚ä¸€ä¸ªå¤æ‚ç•Œé¢ï¼Œå…¶ä¸­çš„å¤šä¸ª View å’Œ ViewGroup ä¼šç»„æˆä¸€ä¸ªæ ‘å½¢çš„ç»“æ„ä½“ï¼Œæ ¹æ˜¯ä¸€ä¸ª ViewGroupï¼Œæœ€æœ«ç«¯çš„æå¶ï¼Œå¯ä»¥æ˜¯ Viewï¼Œä¹Ÿå¯ä»¥æ˜¯ ViewGroupã€‚æˆ‘ä»¬æŠŠè¿™æ ·çš„æ ‘å½¢ç»“æ„ä½“ï¼Œç§°ä¸º ViewTreeã€‚</p>

<h2 id="view-ä¾èµ–çš„ç¯å¢ƒ">View ä¾èµ–çš„ç¯å¢ƒ</h2>
<p>å°±åƒ Android OS éœ€è¦ä¾èµ–ç¡¬ä»¶ç»ˆç«¯æ‰èƒ½è¿è¡Œï¼ŒViewTree ä¹Ÿéœ€è¦è¦æ”¾å…¥ç‰¹å®šçš„ç¯å¢ƒï¼Œæ‰èƒ½å·¥ä½œï¼Œé‚£å°±æ˜¯ Activity ä¸­çš„ PhoneWindow å®ä¾‹ï¼Œå…¶å†…éƒ¨å˜é‡ mDecor ä¼šå¼•ç”¨ ViewTree çš„æ ¹ Viewï¼Œå³ DecorView å®ä¾‹ã€‚å‚è€ƒæ–‡ç«  [[Activity çš„æ ¹View - DecorView]] å’Œ [[Viewçš„å·¥ä½œæµç¨‹çš„æºå¤´]]ï¼Œå¯çŸ¥è¯¦ç»†å†…å®¹ã€‚</p>

<h1 id="viewçš„ä¸‰å¤§å·¥ä½œæµç¨‹">Viewçš„ä¸‰å¤§å·¥ä½œæµç¨‹</h1>
<p>ç”±æ–‡ç«   [[Viewçš„å·¥ä½œæµç¨‹çš„æºå¤´]]  å¯çŸ¥ï¼Œ
â€”
ActivityThread#handleResumeActivity å‡½æ•°<br />
åˆ›å»º ViewRootImpl å®ä¾‹ï¼ŒDecorView å®ä¾‹çš„å¼•ç”¨ä¼ é€’ç»™å…¶å†…éƒ¨çš„ mView å˜é‡ï¼Œç„¶åæ‰§è¡Œ ViewRootImpl#requestLayout å‡½æ•°ï¼Œå¼€å§‹ View çš„å·¥ä½œæµç¨‹ã€‚<br />
requestLayout å‡½æ•°ï¼Œä¼šè§¦å‘ View å·¥ä½œçš„ä¸‰å¤§æµç¨‹ï¼šmeasureï¼Œlayoutï¼Œdrawã€‚<br />
è°ƒç”¨é“¾ï¼š<br />
â€“&gt; ActivityThread#handleResumeActivity â€¦â€¦ <br />
â€“&gt; ViewRootImpl#setView<br />
â€“&gt; ViewRootImpl#requestLayout<br />
â€“&gt; ViewRootImpl#scheduleTraversals<br />
â€“&gt; mChoreographer.postCallback( â€¦ , mTraversalRunnable , â€¦)<br />
â€“&gt; ViewRootImpl#TraversalRunnable.run<br />
â€“&gt; ViewRootImpl#doTraversal<br />
â€“&gt; ViewRootImpl#performTraversals<br />
â€“&gt; ViewRootImpl#performMeasure -&gt; DecorView#measure<br />
â€“&gt; ViewRootImpl#performLayout -&gt; DecorView#layout<br />
â€“&gt; ViewRootImpl#performDraw -&gt; draw -&gt; drawSoftware -&gt; DecorView#draw<br /></p>

<hr />

<h1 id="ç¬¬ä¸€å¤§æµç¨‹æµ‹é‡">ç¬¬ä¸€å¤§æµç¨‹ï¼šæµ‹é‡</h1>
<p>ç”± [[Viewçš„å·¥ä½œæµç¨‹çš„æºå¤´]] å¯çŸ¥ï¼Œä¸€ä¸ª Activity åˆ›å»ºä¹‹åï¼Œé€šè¿‡è¯¥è°ƒç”¨é“¾ï¼š</p>
<ul>
  <li>ActivityThread#handleResumeActivity</li>
  <li>ViewRootImpl#requestLayout</li>
  <li>ViewRootImpl#performTraversals</li>
  <li>ViewRootImpl#performMeasure -&gt; DecorView#measure
è§¦å‘äº† Activity çš„æ ¹View â€“ DecorView çš„æµ‹é‡æµç¨‹ï¼Œ
åŒæ—¶ä¹Ÿæ˜¯è§¦å‘äº†è¯¥ Activity æ•´ä¸ª ViewTree çš„æµ‹é‡æµç¨‹ã€‚</li>
</ul>

<h1 id="æ­¥éª¤æ¦‚è§ˆ">æ­¥éª¤æ¦‚è§ˆï¼š</h1>

<ul>
  <li>ç¬¬é›¶æ­¥ï¼ŒViewRootImpl#performTraversals
    <ul>
      <li>è°ƒç”¨ getRootMeasureSpec æµ‹é‡ DecorView çš„ MeasureSpace</li>
      <li>è°ƒç”¨ performMeasure</li>
    </ul>
  </li>
  <li>ç¬¬ä¸€æ­¥ï¼ŒViewRootImpl#performMeasure
    <ul>
      <li>è°ƒç”¨ DecorView#measure</li>
    </ul>
  </li>
  <li>ç¬¬äºŒæ­¥ï¼ŒDecorView-View#measure
    <ul>
      <li>åˆ¤æ–­æ˜¯å¦éœ€è¦æµ‹é‡ï¼Œè°ƒç”¨ onMeasure</li>
    </ul>
  </li>
  <li>ç¬¬ä¸‰æ­¥ï¼ŒDecorView#onMeasure
    <ul>
      <li>å¼ºåˆ¶è®¾ç½® ç²¾ç¡®æ¨¡å¼</li>
      <li>è°ƒç”¨ FrameLayout#onMeasure
        <ul>
          <li>for å¾ªç¯ï¼šè°ƒç”¨ GroupView#measureChildWithMargins
            <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>getChildMeasureSpec æµ‹é‡ child çš„ å®½/é«˜MeasureSpec
child.measure( childWidthMeasureSpec, childHeightMeasureSpec )
</pre></td></tr></tbody></table></code></pre></div>            </div>
          </li>
          <li>æµ‹å®Œchildï¼Œå†æµ‹è‡ªå·±ï¼ŒView#setMeasuredDimension</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ç¬¬å››æ­¥ï¼Œæ™®é€šViewGroup-View#measureï¼ˆLinearLayout ä¸ºä¾‹ï¼‰
    <ul>
      <li>åˆ¤æ–­æ˜¯å¦éœ€è¦æµ‹é‡ï¼Œè°ƒç”¨ onMeasure</li>
    </ul>
  </li>
  <li>ç¬¬äº”æ­¥ï¼Œæ™®é€šViewGroupçš„å­ç±»#onMeasureï¼ˆLinearLayout ä¸ºä¾‹ï¼‰
    <ul>
      <li>æ ¹æ®å¸ƒå±€ç‰¹ç‚¹ï¼Œåšç‰¹å®šçš„æµ‹é‡
        <ul>
          <li>é‡‡ç”¨åæ ¹åºçš„æ–¹å¼ï¼Œå…ˆéå†æµ‹é‡ childrenï¼Œå†æµ‹é‡è‡ªå·±</li>
        </ul>
      </li>
      <li>ä¾‹å¦‚ï¼šLinearLayout#onMeasureï¼Œ
        <ul>
          <li>è°ƒç”¨ å‚ç›´ æˆ– æ°´å¹³ å¸ƒå±€çš„æµ‹é‡å‡½æ•°
            <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>ç¬¬ä¸€æ¬¡éå† children ï¼Œè®°å½•æœ€å¤§å€¼
ç¬¬äºŒæ¬¡éå† children ï¼Œè°ƒç”¨ child.measureï¼Œå†æ¬¡è®°å½•æœ€å¤§å€¼
æœ€åå†æµ‹é‡è‡ªå·±ï¼Œè°ƒç”¨ setMeasuredDimension
</pre></td></tr></tbody></table></code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ç¬¬å…­æ­¥ï¼Œæ™®é€šViewçš„å­ç±»-View#measureï¼ˆTextView ä¸ºä¾‹ï¼‰
    <ul>
      <li>åˆ¤æ–­æ˜¯å¦éœ€è¦æµ‹é‡ï¼Œè°ƒç”¨ onMeasure</li>
    </ul>
  </li>
  <li>ç¬¬ä¸ƒæ­¥ï¼Œæ™®é€šViewçš„å­ç±»-View#onMeasureï¼ˆTextView ä¸ºä¾‹ï¼‰
    <ul>
      <li>View#onMeasure çš„å®ç°</li>
      <li>TextView#onMeasure çš„å®ç°</li>
    </ul>
  </li>
</ul>

<h2 id="measurespec-çš„ç®€å•ç†è§£">MeasureSpec çš„ç®€å•ç†è§£</h2>
<p>MeasureSpec é¦–å…ˆæ˜¯ View ç±»çš„å†…éƒ¨ç±»ï¼Œç§°ä¸ºæµ‹é‡è§„æ ¼ï¼Œç®€å•çš„è¯´æ˜¯ä¸€ä¸ªçˆ¶ç±»ç»™å­ç±»çš„çº¦æŸã€‚<br />
MeasureSpec ç”¨ä¸€ä¸ª32ä½çš„ int å€¼è¡¨ç¤ºï¼Œé«˜2ä½è¡¨ç¤º SpecModeï¼Œä½30ä½è¡¨ç¤º SpecSizeã€‚<br />
MeasureSpecç±»å†…æä¾›çš„å…³é”®å‡½æ•°ï¼š <br /></p>
<ul>
  <li>makeMeasureSpec (@IntRange(from = 0, to = (1 Â«Â MeasureSpec.MODE_SHIFT) - 1) int size,
                                        @MeasureSpecMode int mode)
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>è¯¥å‡½æ•°å¯ä»¥æŠŠæ¥æ”¶ç‹¬ç«‹çš„ SpecSize å’Œ SpecMode ä½œä¸ºå‚æ•°ï¼Œ åˆæˆä¸€ä¸ª 32 ä½çš„ int ç±»å‹çš„ MeasureSpec å€¼å¹¶è¿”å›ã€‚
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><br /></p>
  </li>
  <li>getMode (int measureSpec)
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ä»ä¸€ä¸ª 32 ä½çš„ int ç±»å‹çš„ MeasureSpec å€¼æå– SpecMode å€¼å¹¶è¿”å›ã€‚
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><br /></p>
  </li>
  <li>getSize (int measureSpec)
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ä»ä¸€ä¸ª 32 ä½çš„ int ç±»å‹çš„ MeasureSpec å€¼æå– SpecSize å€¼å¹¶è¿”å›ã€‚
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>æœ‰äº†è¿™å‡ ä¸ªå‡½æ•°ï¼ŒMeasureSpec çš„è®¡ç®—å¾—åˆ°äº†è§„èŒƒç»Ÿä¸€ã€‚
åç»­æºç åˆ†æä¸­ï¼Œè®¾è®¡æµ‹é‡çš„éƒ½ç”¨åˆ°è¿™å‡ ä¸ªå‡½æ•°ã€‚<br /></p>
  </li>
</ul>

<h1 id="æµ‹é‡æ­¥éª¤æºç è¯¦è§£">æµ‹é‡æ­¥éª¤æºç è¯¦è§£ï¼š</h1>

<h2 id="ç¬¬é›¶æ­¥viewrootimplperformtraversals-æºç ">ç¬¬é›¶æ­¥ï¼ŒViewRootImpl#performTraversals æºç </h2>
<ul>
  <li>è°ƒç”¨ getRootMeasureSpec æµ‹é‡ DecorView çš„ MeasureSpace</li>
  <li>è°ƒç”¨ performMeasure</li>
</ul>

<p>ä»£ç æ®µ0ï¼š
æºç æ¥æºäºï¼š<a href="https://www.androidos.net.cn/android/9.0.0_r8/xref//frameworks/base/core/java/android/view/ViewRootImpl.java">è¯¥é“¾æ¥</a> <br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>// ViewRootImpl ç±»

    private void performTraversals() {
        // cache mView since it is used so much below...
        final View host = mView;

	// 2832 line
	int childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width); // 0-1
	int childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);

	// 2844 line
	 performMeasure(childWidthMeasureSpec, childHeightMeasureSpec); // 0-2
	
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ³¨é‡Š0-1å¤„ï¼Œè°ƒç”¨ getRootMeasureSpec å‡½æ•°ï¼Œæµ‹é‡ DecorView çš„å®½é«˜ MeasureSpec ;
æ³¨é‡Š0-2å¤„ï¼Œè°ƒç”¨ performMeasure å‡½æ•° ï¼Œä¼ å…¥0-1å¤„çš„æµ‹é‡ç»“æœï¼Œç»§ç»­æµç¨‹ã€‚<br /></p>

<ul>
  <li>ç»§ç»­ 0-1 å¤„ï¼ŒgetRootMeasureSpec å‡½æ•°
    <h3 id="getrootmeasurespec-å‡½æ•°">getRootMeasureSpec å‡½æ•°</h3>
    <p>ä»£ç æ®µ0.1ï¼š</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>// ViewRootImpl ç±»

  private static int getRootMeasureSpec(int windowSize, int rootDimension) {
      int measureSpec;
      switch (rootDimension) {

      case ViewGroup.LayoutParams.MATCH_PARENT:
          // Window can't resize. Force root view to be windowSize.
          measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);
          break;
      case ViewGroup.LayoutParams.WRAP_CONTENT:
          // Window can resize. Set max size for root view.
          measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);
          break;
      default:
          // Window wants to be an exact size. Force root view to be that size.
          measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);
          break;
      }
      return measureSpec;
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>æ­¤å¤„å¯ä»¥æ’å…¥ä¸€ä¸ªè¡¨æ ¼è¯´æ˜ï¼Œåˆ—å‡ºä¸‰ç§ç§æƒ…å†µã€‚æš‚ç•¥ã€‚ã€‚ã€‚</p>
  </li>
</ul>

<p>æ‰§è¡Œè¯¥å‡½æ•°å¾—åˆ°çš„å®½é«˜ MeasureSpecï¼Œä¼ å…¥ 0-2 å¤„çš„ performMeasure å‡½æ•°ï¼Œæµç¨‹ç»§ç»­ã€‚<br /></p>

<h2 id="ç¬¬ä¸€æ­¥viewrootimplperformmeasure-æºç ">ç¬¬ä¸€æ­¥ï¼ŒViewRootImpl#performMeasure æºç </h2>
<ul>
  <li>è°ƒç”¨ DecorView#measure</li>
</ul>

<p>ä»£ç æ®µ1:
æºç æ¥æºäºï¼š<a href="https://www.androidos.net.cn/android/9.0.0_r8/xref//frameworks/base/core/java/android/view/ViewRootImpl.java">è¯¥é“¾æ¥</a> <br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>// ViewRootImpl ç±»

    private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) {
        if (mView == null) {
            return;
        }
        Trace.traceBegin(Trace.TRACE_TAG_VIEW, "measure");
        try {
            // 1-1
            mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); 
        } finally {
            Trace.traceEnd(Trace.TRACE_TAG_VIEW);
        }
    }

</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨æ³¨é‡Š 1-1 å¤„ï¼Œè°ƒç”¨ DecorView çš„ measure å‡½æ•°ï¼Œæµç¨‹ç»§ç»­ã€‚</p>

<h2 id="ç¬¬äºŒæ­¥decorview-viewmeasure-æºç ">ç¬¬äºŒæ­¥ï¼ŒDecorView-View#measure æºç </h2>
<ul>
  <li>åˆ¤æ–­æ˜¯å¦éœ€è¦æµ‹é‡ï¼Œè°ƒç”¨ onMeasure
DecorView æ˜¯ View çš„å­ç±»ï¼ŒView çš„ measure å‡½æ•°æ˜¯ final ä¿®é¥°çš„ï¼Œä»»ä½•å­ç±»éƒ½å¿…é¡»ç›´æ¥ä½¿ç”¨ View çš„ measure å‡½æ•°ï¼Œä¸èƒ½é‡å†™ã€‚<br /></li>
</ul>

<p>ä»£ç æ®µ2:
ä»£ç æ¥æºäºï¼š/sdk/sources/android-28/android/view/View.java<br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre>// View ç±»ï¼š

    public final void measure(int widthMeasureSpec, int heightMeasureSpec) {
        boolean optical = isLayoutModeOptical(this);
        if (optical != isLayoutModeOptical(mParent)) {
            Insets insets = getOpticalInsets();
            int oWidth  = insets.left + insets.right;
                int oHeight = insets.top  + insets.bottom;
		// 2-1ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ä¸€ä¸‹ï¼Œä½¿å…¶ä¸ä¸ºè´Ÿæ•°
            widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);
            heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);
        }

        final boolean forceLayout = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;

	   // ã€‚ã€‚ã€‚
        final boolean needsLayout = specChanged
                &amp;&amp; (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize);

        if (forceLayout || needsLayout) { // 2-2 åˆ¤æ–­æ˜¯å¦éœ€è¦æµ‹é‡

            int cacheIndex = forceLayout ? -1 : mMeasureCache.indexOfKey(key);
            if (cacheIndex &lt; 0 || sIgnoreMeasureCache) {
                // measure ourselves, this should set the measured dimension flag back
                     onMeasure(widthMeasureSpec, heightMeasureSpec);  // 2-3
            } else {
                long value = mMeasureCache.valueAt(cacheIndex);
                // Casting a long to int drops the high 32 bits, no mask needed
                setMeasuredDimensionRaw((int) (value &gt;&gt; 32), (int) value);
            }

		// ã€‚ã€‚ã€‚
        }

         mOldWidthMeasureSpec = widthMeasureSpec; // è®°å½•æ—§è§„æ ¼
        mOldHeightMeasureSpec = heightMeasureSpec;
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ 2-2 å¤„ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æµ‹é‡ï¼›
åœ¨ 2-3 å¤„ï¼Œè°ƒç”¨ onMeasure å‡½æ•°ï¼Œå…¶å‚æ•° widthMeasureSpec å’Œ  heightMeasureSpecï¼Œå°±æ˜¯å…¥å‚çš„ä¸¤ä¸ªå‡½æ•° ï¼Œæœ‰å¯èƒ½è°ƒæ•´è¿‡ï¼Œæœ‰å¯èƒ½åŸå°ä¸åŠ¨ã€‚
æµç¨‹ç»§ç»­ã€‚</p>

<h2 id="ç¬¬ä¸‰æ­¥decorviewonmeasure-æºç ">ç¬¬ä¸‰æ­¥ï¼ŒDecorView#onMeasure æºç </h2>
<ul>
  <li>å¼ºåˆ¶è®¾ç½® ç²¾ç¡®æ¨¡å¼</li>
  <li>è°ƒç”¨ FrameLayout#onMeasure
    <ul>
      <li>for å¾ªç¯ï¼šè°ƒç”¨ ViewGroup#measureChildWithMargins
        <ul>
          <li>getChildMeasureSpec æµ‹é‡ child çš„ å®½/é«˜MeasureSpec</li>
          <li>child.measure( childWidthMeasureSpec, childHeightMeasureSpec )</li>
        </ul>
      </li>
      <li>æµ‹å®Œchildï¼Œå†æµ‹è‡ªå·±ï¼ŒView#setMeasuredDimension</li>
    </ul>
  </li>
</ul>

<p>ä»£ç æ®µ3ï¼š
æºç æ¥æºäºï¼š<a href="https://www.androidos.net.cn/android/9.0.0_r8/xref//frameworks/base/core/java/com/android/internal/policy/DecorView.java">è¯¥é“¾æ¥</a><br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre>// DecorView ç±»

    @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {

        final int widthMode = getMode(widthMeasureSpec);
        final int heightMode = getMode(heightMeasureSpec);

        boolean fixedWidth = false;
        mApplyFloatingHorizontalInsets = false;
        if (widthMode == AT_MOST) {
            final TypedValue tvw = isPortrait ? mWindow.mFixedWidthMinor : mWindow.mFixedWidthMajor;
            if (tvw != null &amp;&amp; tvw.type != TypedValue.TYPE_NULL) {
                final int w;
                if (tvw.type == TypedValue.TYPE_DIMENSION) {
                    w = (int) tvw.getDimension(metrics);
                } else if (tvw.type == TypedValue.TYPE_FRACTION) {
                    w = (int) tvw.getFraction(metrics.widthPixels, metrics.widthPixels);
                } else {
                    w = 0;
                }
                if (DEBUG_MEASURE) Log.d(mLogTag, "Fixed width: " + w);
                final int widthSize = MeasureSpec.getSize(widthMeasureSpec);
                if (w &gt; 0) {
                    widthMeasureSpec = MeasureSpec.makeMeasureSpec(
                            Math.min(w, widthSize), EXACTLY);
                    fixedWidth = true;
                } else {
                    widthMeasureSpec = MeasureSpec.makeMeasureSpec(
                            widthSize - mFloatingInsets.left - mFloatingInsets.right,
                            AT_MOST);
                    mApplyFloatingHorizontalInsets = true;
                }
            }
        }

	// heightMode == AT_MOSTï¼Œ è·Ÿ widthMode ä¸€æ ·çš„å¤„ç†é€»è¾‘
        // ...

        super.onMeasure(widthMeasureSpec, heightMeasureSpec);

        // ...
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ DecorView çš„ onMeasure å‡½æ•°ä¸­ï¼Œè‹¥ widthMode == AT_MOSTï¼Œå¼ºåˆ¶å°†å…¶è§„æ ¼æ¨¡å¼è®¾ç½®ä¸º EXACTLYï¼Œç„¶åè°ƒç”¨çˆ¶ç±» FrameLayout çš„ onMeasure å‡½æ•°ã€‚</p>
<h3 id="framelayoutonmeasure-æºç ">FrameLayout#onMeasure æºç </h3>
<p>ä»£ç æ®µ3.1
æºç æ¥æºäºï¼š<a href="https://www.androidos.net.cn/android/9.0.0_r8/xref//frameworks/base/core/java/android/widget/FrameLayout.java">è¯¥é“¾æ¥</a><br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre>// FrameLayout ç±»

    @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
        int count = getChildCount();

        int maxHeight = 0;
        int maxWidth = 0;
        int childState = 0;

        for (int i = 0; i &lt; count; i++) {
            final View child = getChildAt(i);
            if (mMeasureAllChildren || child.getVisibility() != GONE) {
                // 3.1-1 æµ‹é‡ child çš„ MeasureSpecï¼Œ
                // å¹¶è°ƒç”¨ child.measureï¼Œå¼€å¯ child çš„æµ‹é‡æµç¨‹
                measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0);
                final LayoutParams lp = (LayoutParams) child.getLayoutParams();
                maxWidth = Math.max(maxWidth,
                        child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);
                maxHeight = Math.max(maxHeight,
                        child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);
                childState = combineMeasuredStates(childState, child.getMeasuredState());
		// ã€‚ã€‚ã€‚
            }
        }

	// ã€‚ã€‚ã€‚

        // 3.1-2ï¼Œè°ƒç”¨åŸºç±» View ç±»çš„ setMeasuredDimension å‡½æ•°ï¼Œè®¾ç½®å¤§å°
        setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),
                resolveSizeAndState(maxHeight, heightMeasureSpec,
                        childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));

    }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ç€ 3.1-1 å¤„ï¼ŒmeasureChildWithMargins å‡½æ•°æ˜¯åœ¨ ViewGroup ä¸­å®šä¹‰çš„ï¼Œçœ‹æºç ï¼š</p>
<h3 id="viewgroupmeasurechildwithmargins-æºç ">ViewGroup#measureChildWithMargins æºç </h3>
<p>ä»£ç æ®µ3.1.1ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>// ViewGroup ç±»

    protected void measureChildWithMargins(View child,
            int parentWidthMeasureSpec, int widthUsed,
            int parentHeightMeasureSpec, int heightUsed) {
        final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();

        final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,
                mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin
                        + widthUsed, lp.width);
        final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,
                mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin
                        + heightUsed, lp.height);

        child.measure(childWidthMeasureSpec, childHeightMeasureSpec);
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å…¶å†…éƒ¨åˆè°ƒç”¨äº† getChildMeasureSpec å‡½æ•°ã€‚</p>

<h3 id="viewgroupgetchildmeasurespec-æºç ">ViewGroup#getChildMeasureSpec æºç </h3>
<p>ä»£ç æ®µ3.1.1.1ï¼š
ä»£ç æºäºï¼š/sdk/sources/android-28/android/view/ViewGroup.java</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre>// ViewGroup ç±»

    public static int getChildMeasureSpec(int spec, int padding, int childDimension) {
        int specMode = MeasureSpec.getMode(spec);
        int specSize = MeasureSpec.getSize(spec);

        int size = Math.max(0, specSize - padding);

        int resultSize = 0;
        int resultMode = 0;

        switch (specMode) {
        // Parent has imposed an exact size on us
        case MeasureSpec.EXACTLY:
            if (childDimension &gt;= 0) {
                resultSize = childDimension;
                resultMode = MeasureSpec.EXACTLY;
            } else if (childDimension == LayoutParams.MATCH_PARENT) {
                // Child wants to be our size. So be it.
                resultSize = size;
                resultMode = MeasureSpec.EXACTLY;
            } else if (childDimension == LayoutParams.WRAP_CONTENT) {
                // Child wants to determine its own size. It can't be
                // bigger than us.
                resultSize = size;
                resultMode = MeasureSpec.AT_MOST;
            }
            break;

        // Parent has imposed a maximum size on us
        case MeasureSpec.AT_MOST:
            if (childDimension &gt;= 0) {
                // Child wants a specific size... so be it
                resultSize = childDimension;
                resultMode = MeasureSpec.EXACTLY;
            } else if (childDimension == LayoutParams.MATCH_PARENT) {
                // Child wants to be our size, but our size is not fixed.
                // Constrain child to not be bigger than us.
                resultSize = size;
                resultMode = MeasureSpec.AT_MOST;
            } else if (childDimension == LayoutParams.WRAP_CONTENT) {
                // Child wants to determine its own size. It can't be
                // bigger than us.
                resultSize = size;
                resultMode = MeasureSpec.AT_MOST;
            }
            break;

        // Parent asked to see how big we want to be
        case MeasureSpec.UNSPECIFIED:
            if (childDimension &gt;= 0) {
                // Child wants a specific size... let him have it
                resultSize = childDimension;
                resultMode = MeasureSpec.EXACTLY;
            } else if (childDimension == LayoutParams.MATCH_PARENT) {
                // Child wants to be our size... find out how big it should
                // be
                resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;
                resultMode = MeasureSpec.UNSPECIFIED;
            } else if (childDimension == LayoutParams.WRAP_CONTENT) {
                // Child wants to determine its own size.... find out how
                // big it should be
                resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;
                resultMode = MeasureSpec.UNSPECIFIED;
            }
            break;
        }
        //noinspection ResourceType
        return MeasureSpec.makeMeasureSpec(resultSize, resultMode);
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ­¤å¤„åº”æ”¾ä¸€ä¸ªè¡¨æ ¼ï¼Œåˆ—å‡ºä¹ç§æƒ…å†µã€‚æš‚ç•¥ã€‚ã€‚ã€‚</p>

<p>å›åˆ°ä»£ç æ®µ3.1ï¼Œçœ‹æ³¨é‡Š 3.1-2 å¤„ï¼Œè°ƒç”¨ View ç±»çš„ setMeasuredDimension å‡½æ•°ã€‚</p>
<h3 id="viewsetmeasureddimension-æºç ">View#setMeasuredDimension æºç </h3>
<p>ä»£ç æ®µ3.1.2ï¼š
ä»£ç æ¥æºäºï¼š/sdk/sources/android-28/android/view/View.java<br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>    protected final void setMeasuredDimension(int measuredWidth, int measuredHeight) {
        boolean optical = isLayoutModeOptical(this);
        if (optical != isLayoutModeOptical(mParent)) {
            Insets insets = getOpticalInsets();
            int opticalWidth  = insets.left + insets.right;
            int opticalHeight = insets.top  + insets.bottom;

            measuredWidth  += optical ? opticalWidth  : -opticalWidth;
            measuredHeight += optical ? opticalHeight : -opticalHeight;
        }
        setMeasuredDimensionRaw(measuredWidth, measuredHeight);
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>    private void setMeasuredDimensionRaw(int measuredWidth, int measuredHeight) {
        mMeasuredWidth = measuredWidth;
        mMeasuredHeight = measuredHeight;

        mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ç¬¬å››æ­¥æ™®é€šviewgroup-viewmeasure">ç¬¬å››æ­¥ï¼Œæ™®é€šViewGroup-View#measure</h2>
<ul>
  <li>åˆ¤æ–­æ˜¯å¦éœ€è¦æµ‹é‡ï¼Œè°ƒç”¨ onMeasure
View çš„ measure å‡½æ•°æ˜¯ final ä¿®é¥°çš„ï¼Œæ‰€ä»¥ VIew å­ç±»è°ƒç”¨ measure å‡½æ•°æ—¶ï¼Œåªèƒ½è°ƒç”¨ View#measure
è·Ÿä»£ç æ®µ2çš„ä¸€è‡´ï¼Œæ­¤å¤„çœç•¥ã€‚</li>
</ul>

<h2 id="ç¬¬äº”æ­¥æ™®é€šviewgroupçš„å­ç±»onmeasurelinearlayout-ä¸ºä¾‹">ç¬¬äº”æ­¥ï¼Œæ™®é€šViewGroupçš„å­ç±»#onMeasureï¼ˆLinearLayout ä¸ºä¾‹ï¼‰</h2>
<p>ViewGroup ç±»æœ¬èº«çš„ onMeasure æ˜¯ç©ºçš„ï¼Œç•™ç»™å­ç±»å»å®ç°ï¼Œä»¥æ»¡è¶³ä¸åŒå¸ƒå±€çš„æµ‹é‡éœ€æ±‚ã€‚
ViewGroup çš„å­ç±»ä¸€èˆ¬åšçš„äº‹ï¼š<br /></p>
<ul>
  <li>æ ¹æ®å¸ƒå±€ç‰¹ç‚¹ï¼Œåšç‰¹å®šçš„æµ‹é‡
    <ul>
      <li>é‡‡ç”¨åæ ¹åºçš„æ–¹å¼ï¼Œå…ˆéå†æµ‹é‡ childrenï¼Œå†æµ‹é‡è‡ªå·±</li>
    </ul>
  </li>
  <li>ä¾‹å¦‚ï¼šLinearLayout#onMeasureï¼Œ
    <ul>
      <li>è°ƒç”¨ å‚ç›´ æˆ– æ°´å¹³ å¸ƒå±€çš„æµ‹é‡å‡½æ•°
        <ul>
          <li>ç¬¬ä¸€æ¬¡éå† children ï¼Œè®°å½•æœ€å¤§å€¼</li>
          <li>ç¬¬äºŒæ¬¡éå† children ï¼Œè°ƒç”¨ child.measureï¼Œå†æ¬¡è®°å½•æœ€å¤§å€¼</li>
          <li>æœ€åå†æµ‹é‡è‡ªå·±ï¼Œè°ƒç”¨ setMeasuredDimension</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="linearlayoutonmeasure-æºç ">LinearLayout#onMeasure æºç </h3>
<p>ä»£ç æ®µ5ï¼š
ä»£ç æºäºï¼š/sdk/sources/android-28/android/widget/LinearLayout.java</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>// LinearLayout ç±»

    @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
        if (mOrientation == VERTICAL) {
            measureVertical(widthMeasureSpec, heightMeasureSpec);
        } else {
            measureHorizontal(widthMeasureSpec, heightMeasureSpec);
        }
    }
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="linearlayoutmeasurevertical-æºç ">LinearLayout#measureVertical æºç </h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre>// LinearLayout ç±»

	// ç¬¬ä¸€ééå† childrenï¼Œè®°å½•å®½åº¦çš„æœ€å¤§å€¼ maxWidth
        for (int i = 0; i &lt; count; ++i) {
		//ã€‚ã€‚ã€‚
		final int margin = lp.leftMargin + lp.rightMargin;
		final int measuredWidth = child.getMeasuredWidth() + margin;
		maxWidth = Math.max(maxWidth, measuredWidth);
		//ã€‚ã€‚ã€‚
	}

	// ç¬¬äºŒééå† childrenï¼Œè°ƒç”¨ child.measureï¼Œå¹¶æ›´æ–°å®½åº¦çš„æœ€å¤§å€¼ maxWidth
	 for (int i = 0; i &lt; count; ++i) {
                final View child = getVirtualChildAt(i);
                if (child == null || child.getVisibility() == View.GONE) {
                    continue;
                }

                final LayoutParams lp = (LayoutParams) child.getLayoutParams();
                final float childWeight = lp.weight;
                if (childWeight &gt; 0) {

                    final int childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(
                            Math.max(0, childHeight), MeasureSpec.EXACTLY);
                    // getChildMeasureSpec å‡½æ•°æºç ï¼ŒåŒä»£ç æ®µ3.1.1.1
                    final int childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,
                            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin,
                            lp.width);
                    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);

                }

                final int margin =  lp.leftMargin + lp.rightMargin;
                final int measuredWidth = child.getMeasuredWidth() + margin;
                maxWidth = Math.max(maxWidth, measuredWidth);
	}

	
	maxWidth += mPaddingLeft + mPaddingRight;
        maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());
	// æµ‹å®Œchildï¼Œå†æµ‹è‡ªå·±ï¼ŒsetMeasuredDimension æºç ï¼ŒåŒä»£ç æ®µ3.1.2
        setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),
                heightSizeAndState);
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ç¬¬å…­æ­¥æ™®é€šviewçš„å­ç±»-viewmeasure-æºç ">ç¬¬å…­æ­¥ï¼Œæ™®é€šViewçš„å­ç±»-View#measure æºç </h2>
<ul>
  <li>åˆ¤æ–­æ˜¯å¦éœ€è¦æµ‹é‡ï¼Œè°ƒç”¨ onMeasure
View çš„ measure å‡½æ•°æ˜¯ final ä¿®é¥°çš„ï¼Œæ‰€ä»¥ VIew å­ç±»è°ƒç”¨ measure å‡½æ•°æ—¶ï¼Œåªèƒ½è°ƒç”¨ View#measure
è·Ÿä»£ç æ®µ2çš„ä¸€è‡´ï¼Œæ­¤å¤„çœç•¥ã€‚</li>
</ul>

<h2 id="ç¬¬ä¸ƒæ­¥æ™®é€šviewçš„å­ç±»-viewonmeasure">ç¬¬ä¸ƒæ­¥ï¼Œæ™®é€šViewçš„å­ç±»-View#onMeasure</h2>
<h3 id="viewonmeasure-æºç ">View#onMeasure æºç </h3>
<p>ä»£ç æ®µ7:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>// View ç±»ï¼š

    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
        setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),
                getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));
    }

    protected final void setMeasuredDimension(int measuredWidth, int measuredHeight) {
        boolean optical = isLayoutModeOptical(this);
        if (optical != isLayoutModeOptical(mParent)) {
            Insets insets = getOpticalInsets();
            int opticalWidth  = insets.left + insets.right;
            int opticalHeight = insets.top  + insets.bottom;

            measuredWidth  += optical ? opticalWidth  : -opticalWidth;
            measuredHeight += optical ? opticalHeight : -opticalHeight;
        }
        setMeasuredDimensionRaw(measuredWidth, measuredHeight);
    }

    private void setMeasuredDimensionRaw(int measuredWidth, int measuredHeight) {
        mMeasuredWidth = measuredWidth;
        mMeasuredHeight = measuredHeight;

        mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="viewgetsuggestedminimumwidth-æºç ">View#getSuggestedMinimumWidth æºç </h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>// View ç±»ï¼š

    // è·å¾— mMinWidth å’Œ èƒŒæ™¯æœ€å°å®½åº¦ä¹‹é—´çš„æœ€å¤§å€¼
    protected int getSuggestedMinimumWidth() {
        return (mBackground == null) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="viewgetdefaultsize-æºç ">View#getDefaultSize æºç </h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>// View ç±»ï¼š

    // è·å¾—çº¯å°ºå¯¸ï¼Œè€Œä¸æ˜¯æµ‹é‡è§„æ ¼
    public static int getDefaultSize(int size, int measureSpec) {
        int result = size;
        int specMode = MeasureSpec.getMode(measureSpec);
        int specSize = MeasureSpec.getSize(measureSpec);

        switch (specMode) {
        case MeasureSpec.UNSPECIFIED:
            result = size;
            break;
        case MeasureSpec.AT_MOST:
        case MeasureSpec.EXACTLY:
            result = specSize;
            break;
        }
        return result;
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p>æ™®é€šçš„ View å­ç±»ï¼Œå‡ ä¹éƒ½ä¼šé‡å†™ View#onMeasure å‡½æ•°ï¼Œè‡ªå·±è¿›è¡Œä¸€ç•ªå¤„ç†åï¼Œå†è°ƒç”¨ setMeasuredDimension è®¾ç½®ç»“æœã€‚</p>
  </li>
  <li>
    <p>ä¾‹å­ï¼šTextView#onMeasure çš„å®ç°</p>
    <h3 id="textviewonmeasure-æºç ">TextView#onMeasure æºç </h3>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre>  @Override
  protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
      int widthMode = MeasureSpec.getMode(widthMeasureSpec);
      int heightMode = MeasureSpec.getMode(heightMeasureSpec);
      int widthSize = MeasureSpec.getSize(widthMeasureSpec);
      int heightSize = MeasureSpec.getSize(heightMeasureSpec);

      int width;
      int height;

  // ã€‚ã€‚ã€‚

      if (widthMode == MeasureSpec.EXACTLY) {
          // Parent has told us how big to be. So be it.
          width = widthSize;
      } else {

      //  è¿›è¡Œä¸€ç•ªåˆ¤æ–­æ¯”è¾ƒ

          // Check against our minimum width
          width = Math.max(width, getSuggestedMinimumWidth());

          if (widthMode == MeasureSpec.AT_MOST) {
              width = Math.min(widthSize, width);
          }
      }

  // ã€‚ã€‚ã€‚

      if (heightMode == MeasureSpec.EXACTLY) {
          // Parent has told us how big to be. So be it.
          height = heightSize;
          mDesiredHeightAtMeasure = -1;
      } else {
          int desired = getDesiredHeight();

          height = desired;
          mDesiredHeightAtMeasure = desired;

          if (heightMode == MeasureSpec.AT_MOST) {
              height = Math.min(desired, heightSize);
          }
      }

  // ã€‚ã€‚ã€‚

  // æœ€ç»ˆç»“æœä¿å­˜åœ¨å˜é‡ width, heightï¼Œå¹¶è®¾ç½® 
      setMeasuredDimension(width, height);
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <h3 id="æœ€åæ€»ç»“">æœ€åæ€»ç»“</h3>
  </li>
</ul>

<p>å€Ÿç”¨è¯¥é“¾æ¥ï¼š[å‡¶æ®‹çš„ç¨‹åºå‘˜-View çš„å·¥ä½œæµç¨‹] ( https://blog.csdn.net/qian520ao/article/details/78657084 ) çš„ä¸€å¼ å›¾ï¼Œæ¥è¡¨ç¤ºå¤§è‡´çš„å·¥ä½œæµç¨‹ã€‚
<img src="https://upload-images.jianshu.io/upload_images/9124992-af00916cc0d4414d.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200" alt="" /></p>

<p>å†æ¥ä¸€å¼ è¡¨æ ¼ï¼Œå±•ç¤º measure å‡½æ•° å’Œ onMeasure å‡½æ•°åœ¨ä¸åŒç±»å®ç°ä¸Šçš„ä¸€äº›åŒºåˆ«ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Â </th>
      <th style="text-align: left">measure</th>
      <th style="text-align: left">onMeasure</th>
      <th style="text-align: left">Â </th>
      <th style="text-align: left">measure</th>
      <th style="text-align: left">onMeasure</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ViewGroup</td>
      <td style="text-align: left">nullï¼Œè°ƒç”¨View#measure</td>
      <td style="text-align: left">null</td>
      <td style="text-align: left">View</td>
      <td style="text-align: left">åˆ¤æ–­æ˜¯å¦è¦æµ‹é‡ï¼Œè°ƒç”¨ onMeasure</td>
      <td style="text-align: left">é»˜è®¤çš„è®¾ç½®å°ºå¯¸é€»è¾‘</td>
    </tr>
    <tr>
      <td style="text-align: left">ViewGroupå­ç±»</td>
      <td style="text-align: left">null</td>
      <td style="text-align: left">æ ¹æ®è‡ªèº«å¸ƒå±€çš„ç‰¹ç‚¹æ¥æµ‹é‡å­ Viewï¼Œå…¶ä¸­ä¼šè°ƒç”¨åˆ° ViewGroup çš„ measureChildWithMargins å‡½æ•° å’Œ getChildMeasureSpec å‡½æ•°ï¼›æµ‹å‡ºå­ View çš„è§„æ ¼åã€‚forå¾ªç¯ï¼šè°ƒç”¨ child.measure è§¦å‘å­ View çš„æµ‹é‡æµç¨‹ï¼Œå¹¶ä¼ é€’è§„æ ¼ç»™å­ View</td>
      <td style="text-align: left">Viewå­ç±»</td>
      <td style="text-align: left">null</td>
      <td style="text-align: left">å®Œå…¨é‡å†™ï¼Œæ ¹æ®è‡ªèº«ç‰¹ç‚¹æ¥æµ‹é‡ï¼Œè°ƒç”¨View#setMeasuredDimensionæ¥ä¿å­˜æµ‹é‡å°ºå¯¸</td>
    </tr>
  </tbody>
</table>

:ET